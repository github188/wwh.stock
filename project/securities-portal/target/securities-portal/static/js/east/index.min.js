var upatetimer = new LazyTimer(1000 * 15);
var win = window, doc = document;
var lazys = [];

//沪深股市/今日热点
(function() {
    var hottoday = "http://183.136.160.92/EM_UBG_Finance2016TransferExtendInterface/js.ashx?type=HotToday&cmd=&js=&cb=var%20hotToday=";

    //沪深股市
    var hs = {
        chart: new ChartView(mini("#hsindex img")),
		render:function(){
			this.chart.render();
		},
		
        update: function() {
            if (quote.HSOpening) {
                this.render();
            }
        }
    };

    //今日热点
    var hot = {

        createUI: function(data) {
            var stocks = data.stock;
            var cashflow = data.cashflow;

            var i;
            for (i = 0; i < stocks.length; i++) {
                stocks[i] = stocks[i].split(",");
                //stocks[i].css = quote.getCssByChange(stocks[i][2]);
            }

            for (i = 0; i < cashflow.length; i++) {
                cashflow[i] = cashflow[i].split(",");
            }

            var uid = utils.uid();

            mini("#lzhy")[0].innerHTML = '<a href="'+portalurl+'stockeast/marketlist#28002' + data.trade[0] + '_0_2" target="_self">' +
											'<img width="240"alt="领涨" heigth="135" src="http://cmsjs.eastmoney.com/data/images/' + data.trade[0] + '.png?dt=' + uid + '" /></a>' +
										 '<dl class="img-text">' +
											 '<dt>领涨股:</dt>' +
											 '<dd><a class="name" href="http://quote.eastmoney.com/' + stocks[0][0] + '.html" target="_blank">' + stocks[0][1] + '</a>' +
											 	  '<span class="s1 red">' + stocks[0][2] + '</span><span class="s1 red">' + stocks[0][3] + '</span></dd>' +
											 '<dd><a class="name" href="http://quote.eastmoney.com/' + stocks[1][0] + '.html" target="_blank">' + stocks[1][1] + '</a>' +
											 	  '<span class="s1 red">' + stocks[1][2] + '</span><span class="s1 red">' + stocks[1][3] + '</span></dd>' +
										 '</dl>';

            mini("#ldhy")[0].innerHTML = '<a href="'+portalurl+'stockeast/marketlist#28002' + data.trade[2] + '_0_2" target="_self">' +
											'<img width="240" heigth="135" src="http://cmsjs.eastmoney.com/data/images/' + data.trade[2] + '.png?dt=' + uid + '" /></a>' +
										 '<dl class="img-text">' +
											 '<dt>领跌股:</dt>' +
											 '<dd><a class="name" href="http://quote.eastmoney.com/' + stocks[2][0] + '.html" target="_blank">' + stocks[2][1] + '</a>' +
											 	  '<span class="s1 green">' + stocks[2][2] + '</span><span class="s1 green">' + stocks[2][3] + '</span></dd>' +
											 '<dd><a class="name" href="http://quote.eastmoney.com/' + stocks[3][0] + '.html" target="_blank">' + stocks[3][1] + '</a>' +
											 	  '<span class="s1 green">' + stocks[3][2] + '</span><span class="s1 green">' + stocks[3][3] + '</span></dd>' +
										 '</dl>';

            mini("#hyzjl")[0].innerHTML = '<img width="240" heigth="135" src="http://cmsjs.eastmoney.com/data/images/A股流入资金.png?dt=' + uid + '" />' +
										 '<dl class="img-text">' +
											 '<dt>资金流入排名:</dt>' +
											 '<dd><a class="name" href="'+portalurl+'stockeast/marketlist#28002' + cashflow[0][0] + '_0_2" target="_self">' + cashflow[0][1] + '</a>' +
											 	  '<span class="red">' + cashflow[0][2] + '</span></dd>' +

											 '<dd><a class="name" href="'+portalurl+'stockeast/marketlist#28002' + cashflow[1][0] + '_0_2" target="_self">' + cashflow[1][1] + '</a>' +
											 	 '<span class="red">' + cashflow[1][2] + '</span></dd>' +
										 '</dl>';


        },

        load: function() {
            var uid = +new Date();
            var _this = this;
            //loading
            ajax.getScript(hottoday + "&v=" + uid, "gbk", function() {
                _this.createUI(hotToday);
            });

        },

        init: false,

        update: function() {
            if (!this.init || quote.HSOpening) {
                this.load();
                this.init = true;
            }
        }
    };

    var tab1 = new TabView();
    var models = [hs, hot];
    var index = upatetimer.add(models[0]);
    tab1.tabs = mini("#tab1 li");
    tab1.panels = mini("#tab1panels .tab-panel");
    tab1.onchange = function(i) {
        models[i].update();
        upatetimer.set(index, models[i]);
    };
	hs.render();
    tab1.init("click", "current");
} ());

//我的自选股
(function(){
	var DOMCache = {}, dataCache = {};  
	DOMCache["mystocks"] = mini("#mystocks")[0];
	DOMCache["LoginForm"] = mini("#loginForm")[0];
	DOMCache["UserInfo"] = mini("#userInfo")[0];
	DOMCache["submitLogin"] = mini("#submitLogin")[0];
	DOMCache["userExit"] = mini("#userExit")[0];
	DOMCache["UserNameText"] = mini("#userNameText")[0];
	
	var textgif = new TextGif(DOMCache["mystocks"]);

//class MyStocksDataSource{ 
	/**
	 * function MyStocksDataSource(callBack,stocks) : void
	 * 自选股数据源,使用HSDataSource对象转发调用
	 * @param {Function} callBack  数据加载完成后回调
	 * @param {Array} stocks  股票ID数组
	 */
	function MyStocksDataSource(callBack,stocks) {
		this.params = "?type=z&jsName=quote_mystocks&reference=rtj&ids=" + stocks.join(",");
		this.callBack = callBack;
		this.jsName = "quote_mystocks";
		this.load();
	}
	
	MyStocksDataSource.prototype = {
		callBack: new Function(),
		
		load: function(update) {
			var _ = this;
			var host = config.hqdigi2;
			var params = _.params;
			
			ajax.getScript(host + params + "&v=" + Math.random(), "utf-8", function() {
				_.callBack(win[_.jsName].quotation);
				if (update && _.onupdatecomplate) {
					_.onupdatecomplate();
				}
			});
		},
		
		update: function() {
			var updateLoad = true;
			if (quote.HSOpening)//沪深开盘
				this.load(updateLoad);
		}
		
	};
	
//}

//class User{ 

	function User() {
		this.isLogined = !!cookie.get("pi");
		this.userName = "";
		if (this.isLogined) {
			this.userName = cookie.get("pi").split(";")[2];
		}
	}
	
	User.exit = function() {
		var date = new Date();
		cookie.clear("dcusername");
		cookie.clear("dcuserinfo");
		cookie.clear("dcusermingchen");
		cookie.clear("dcuserpass");
		cookie.clear("dcuserpubinfo");
		cookie.clear("dcuserpubs");
		cookie.clear("dcuserkeys");
		cookie.clear("dcuser_name");
		cookie.clear("dcuser_info");
		cookie.clear("dcuser_mingchen");
		cookie.clear("dcuser_pass");
		cookie.clear("dcuser_pubinfo");
		cookie.clear("dcuser_pubs");
		cookie.clear("dcuser_keys");
		cookie.clear("puser_pname");
		cookie.clear("puser_pinfo");
		cookie.clear("pi");

	};
	
	User.asynLogin = function(userName, userPwd, callBackName) {
		var url = 'http://passport.eastmoney.com/HQLogin.EmUser?' + userName + ',' + userPwd +',' + Math.random();
		ajax.getScript(url, "utf-8", new Function);
	};
	
	User.prototype = {
		
		_FavorSettle: function(dflist) {
			var arr_res = new Array();
			if (!dflist) dflist = "";

            if (!dflist) dflist += ",600005,600006,600007,600008,600009"; //设置默认自选股代码
            var list = dflist.split(",").unique();

            for (var i = 0; i < list.length; i++) {
                if (list[i] !== "") {
                    var code = list[i];
                    var market = quote.getMarkesBycode(code);

                    arr_res.push(code + "" + market);
                }
            }
            return arr_res.splice(0, 10);
		},
		
		getMystocks: function() {
			return this._FavorSettle(cookie.get("emhq_stock"));
		},
	
		asynGetMystocks: function(callback, context, url) {
			var _this = this;
			ajax.getScript(url, "utf-8", function() {
				callback.call(context, _this._FavorSettle(allstocklist));
			});
		}
	};
	
	

//}

//class MYStockView{ 

	function MYStockView() {
		var profile = new User();
		if (profile.isLogined) {
			profile.asynGetMystocks(this.render, this, "http://mystock.eastmoney.com/api4quote_list.php?n=10&i=1&math=" + Math.random());
			this.showUserInfo(profile);
			
		} else {
			//var stocks = profile.getMystocks();
            //this.render(stocks);
            profile.asynGetMystocks(this.render, this, portalurl+"stockeast/selflist");
            this.showLoginForm();
		}
	}
	
	MYStockView.prototype = {
		
		showUserInfo: function(profile) {
			DOMCache["UserInfo"].className = "";
			DOMCache["LoginForm"].className = "none";
			DOMCache["UserInfo"].style.display = "";
			DOMCache["LoginForm"].style.display = "none";
			DOMCache["UserNameText"].innerHTML = profile.userName;
		},
		
		showLoginForm: function() {
			DOMCache["UserInfo"].style.display = "none";
			DOMCache["LoginForm"].style.display = "";
			DOMCache["UserInfo"].className = "none";
			DOMCache["LoginForm"].className = "";
		},
		
		//stocks 股票id的数组
		render: function(stocks) {
			this.ds = new MyStocksDataSource(this.showStockList, stocks);
			this.ds.onupdatecomplate  = function(){
				textgif.init();
			};
			
			MYStockView.timerIndext =  upatetimer.add(this.ds);
		},
		
		showStockList: function(dt) {
			var priceCss, changeCss, rowCss, fileName;
			var n = dt.length;
			var data, table = [];
			var empty = [];
			table[0] = '<table class="data-table" width="100%">' +
							'<th>代码</th>' +
							'<th>名称</th>' +
							'<th>相关链接</th>' +
							'<th>最新价</th>' +
							'<th>涨跌额</th>' +
							'<th>涨跌幅</th>' +
							'<th>买入</th>' +
							'<th>卖出</th>' +
							'<th>成交量(手)</th>' +
							'<th>成交额(万)</th>' +
							'<th>今开</th>' +
							'<th>昨收</th>' +
							'<th>最高</th>' +
							'<th>最低</th>' +
							'</tr>';
							
			table[n + 1] = '</table>';
							
			var rowIndex = 0, gif = "";
			
			for (var i = 0; i < n; ) {
				data = dt[i++].split(",");
				if (data.length < 2) continue; //新股没有行情数据
				
				if( dataCache[ i+ "-change" ] && data[5] != dataCache[ i+ "-change" ]){
					gif = "js-gif ";
				}else {
					gif = "";
				}
				
				dataCache[i + "-change" ] = data[5];
				
				rowCss = (rowIndex % 2 === 0) ? ' class="bg"' : '';
				rowIndex++;
				changeCss = quote.getCssByChange(data[10]);				
				fileName = (data[0].slice(-1) == 1 ? "sh": "sz") + data[1];
				table[i] = '<tr' + rowCss + '>' +
							'<td><a href="'+portalurl+'stockeast/detail?stockCode=' + data[1] + '" target="_self">' + data[1] + '</a></td>' +
							'<td><a href="'+portalurl+'stockeast/detail?stockCode=' + data[1] + '" target="_self">' + data[2] + '</a></td>' +
							'<td><a href="http://guba.eastmoney.com/topic,' + data[1] + '.html" target="_blank">股吧</a> <a href="http://data.eastmoney.com/zjlx/' + data[1] + '.html" target="_blank">资金流</a> <a href="http://data.eastmoney.com/report/'+data[1]+'.html" target="_blank">研报</a></td>' +
							'<td><span class="'+ gif + changeCss + '" >' + data[5] + '</span></td>' +
							'<td><span class="'+ gif + changeCss + '">' + data[10] + '</span></td>' +
							'<td><span class="'+ gif + changeCss+ '">' + data[11] + '</span></td>' +
							'<td><span class="digi">' + data[26] + '</span></td>' +
							'<td><span class="digi">' + data[27] + '</span></td>' +
							'<td><span class="digi">' + data[9] + '</span></td>' +
							'<td><span class="digi">' + data[8] + '</span></td>' +
							'<td><span class="digi">' + data[4] + '</span></td>' +
							'<td><span class="digi">' + data[3] + '</span></td>' +
							'<td><span class="digi">' + data[6] + '</span></td>' +
							'<td><span class="digi">' + data[7] + '</span></td>' +
							'</tr>';
			}
		
			DOMCache["mystocks"].innerHTML = table.join("");
			
		}
	};

//}

	var strocview = new MYStockView();
	DOMCache["submitLogin"].onclick = function () {
		
		ajax.getScript("http://hqres.eastmoney.com/EMQuote_Lib/js/passportform.js","gb2312", function(){
			 Default.htdsLogin();				 	
		});	
	};

	DOMCache["userExit"].onclick = function() {
		User.exit();
		upatetimer.remove(MYStockView.timerIndext);
		strocview = new MYStockView();
	};
	
}());

//个股综合排行榜
(function(){
		  
//class Model {
	
	function Model (param, view){	
		this.param = param;
		this.view = view;
	}
	
	Model.prototype = {
		
		load: function(){
			
			var param = this.param;
			var url =  config.hqdigi2 + "?" + queryString.serialize(param);
			var view = this.view;
			
			ajax.getScript(url, "utf-8", function(){
				 view.render( window[param.jsName].rank );
			});
		},
		
		update: function(){
			
			if(quote.HSOpening){
				this.load();
			}
		}
	
	};
//}


//Class {
	
	function Header(linksID, moreID) {
		
		this.linksID = linksID;
		this.moreID = moreID;
	}
	
	Header.prototype = {
			
		linksID: "",
		
		moreID:"",
		
		data: {
			
			hashkey: "10_0_0_u",
			
			sortRule: "-1",
			
			name: "沪A"
		},
		
		template: {
			
			links: '<a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=I&sortRule={$sortRule}" target="_blank">{$name}市盈率排行</a>'+
				   '<a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=J&sortRule={$sortRule}" target="_blank">{$name}换手率排行</a>'+
				   '<a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=H&sortRule={$sortRule}" target="_blank">{$name}量比排行</a>'+
				   '<a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=G&sortRule={$sortRule}" target="_blank">{$name}5分钟排行</a>',
			
			more: '<a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=C&sortRule={$sortRule}" target="_blank">更多</a>'
		
		},
		
		replace: function (tmpl){
			
				return tmpl.replace(/\{\$hashkey\}/g, this.data.hashkey).
							 replace(/\{\$sortRule\}/g, this.data.sortRule).
							 replace(/\{\$name\}/g, this.data.name);
		},
		
		render: function(data){
			
			this.data = data;
			
			mini(this.linksID)[0].innerHTML = this.replace(this.template.links);
			
			mini(this.moreID)[0].innerHTML = this.replace(this.template.more);
		}
	};
	
//}

//class View
	
	function View(container, hashkey){
		if(container) {
			
			this.container = container;
		}
		
		if(hashkey) {
			
			this.hashkey = hashkey;
		}
		
	}
	
	View.prototype = {
		
		container: document.getElementById("SHUP"),
		
		sortRule: -1,
		
		"icon-change": "icon-change-up",
		
		hashkey: "10_0_0_u",
		
		template: {
			
				header: '<table width="100%" class="data-table">'+
						  '<tr>'+
							'<th>代码</th>'+
							'<th>名称</th>'+
							'<th>相关链接</th>'+
							'<th><a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=B&sortRule={$sortRule}" target="_blank">最新价</a></th>'+
							'<th><a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=D&sortRule={$sortRule}" target="_blank">涨跌额</a></th>'+
							'<th><a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=C&sortRule={$sortRule}" target="_blank">涨跌幅</a>'+
								 '<b class="{$changeicon}"></b></th>' +
							'<th><a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=K&sortRule={$sortRule}" target="_blank">振幅</a></th>'+
							'<th><a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=F&sortRule={$sortRule}" target="_blank">成交量(手)</a></th>'+
							'<th><a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=E&sortRule={$sortRule}" target="_blank">成交额(万)</a></th>'+
							'<th>昨收</th>'+
							'<th>今开</th>'+
							'<th>最高</th>'+
							'<th>最低</th>'+
							'<th><a href="'+portalurl+'stockeast/marketlist#{$hashkey}?sortType=G&sortRule={$sortRule}" target="_blank">5分钟涨跌</a></th>'+
							'<th>加自选</th>'+
						  '</tr>',
						  
				repeatItem: '<tr>'+
							'<td><a href="'+portalurl+'stockeast/detail?stockCode={$dataRow[1]}" target="_self">{$dataRow[1]}</a></td>'+
							'<td><a href="'+portalurl+'stockeast/detail?stockCode={$dataRow[1]}" target="_self">{$dataRow[2]}</a></td>'+
							'<td><a href="http://guba.eastmoney.com/topic,{$dataRow[1]}.html" target="_blank">股吧</a> <a href="http://data.eastmoney.com/zjlx/{$dataRow[1]}.html" target="_blank">资金流</a> <a href="http://data.eastmoney.com/report/{$dataRow[1]}.html" target="_blank">研报</a></td>'+
							'<td><span class="{$css[change]}">{$dataRow[5]}</span></td>'+
							'<td><span class="{$css[change]}">{$dataRow[10]}</span></td>'+
							'<td><span class="{$css[change]}">{$dataRow[11]}</span></td>'+
							'<td><span class="digi">{$dataRow[13]}</span></td>'+
							'<td><span class="digi">{$dataRow[9]}</span></td>'+
							'<td><span class="digi">{$dataRow[8]}</span></td>'+
							'<td><span class="digi">{$dataRow[3]}</span></td>'+
							'<td><span class="{$css[open]}">{$dataRow[4]}</span></td>'+
							'<td><span class="{$css[high]}">{$dataRow[6]}</span></td>'+
							'<td><span class="{$css[low]}">{$dataRow[7]}</span></td>'+
							'<td><span class="digi">{$dataRow[21]}</span></td>'+
							'<td><a class="icon-plus" href="'+portalurl+'stockeast/addstock?code={$dataRow[1]}" target="_self"></a></td>'+
						  '</tr>',
					  
				footer: '</table>'
		},
		
		render: function (dt){
			
			var container = this.container,
				headerhtml = this.template.header,
				rowhtml = this.template.repeatItem,
				footerhtml = this.template.footer;
				 
			var repeater = new Repeater(headerhtml, rowhtml, footerhtml);
			var dataRow = [];
			
			for(var i=0,n=dt.length; i<n; i++){
				dataRow = dt[i].split(",");
				cssClass = new StockCssClass(dataRow);
				
				repeater.set("dataRow", dataRow);
				repeater.set("css", cssClass);
				repeater.set("prefix", quote.getMarketPrefixById(dataRow[0]));
				repeater.parse();
			}
			container.innerHTML = repeater.toHTML( { sortRule: this.sortRule, "changeicon": this["icon-change"], hashkey: this.hashkey } );
		}
	
	};
//}
	
	//沪A涨幅/沪A跌幅
	var shheader = new Header("#shlinks", "#shmore");
	var shview = new View();
	var shparam = queryString.parse("?type=s&sortType=C&sortRule=-1&pageSize=10&page=1&jsName=quote_sha&style=10");
	var shmodel = new Model( shparam, shview);
	shmodel.lazyElem = shview.container;
	
	var shtimerindex = upatetimer.add(shmodel);
	var shtab = new TabView();
	shtab.tabs = mini("#tab2 li");
	shtab.panels = mini("#tab2panels .tab-panel");
	shtab.init("click", "current");
	shtab.onchange = function(i){
		controll["tab-" + i]();
		
		shmodel.lazyElem = shmodel.view.container;
		upatetimer.set(shtimerindex, shmodel);
		
	};
	
	//深圳A涨幅/深圳A跌幅
	var szheader = new Header("#szlinks", "#szmore");
	var szview = new View( mini("#SZUP")[0], "20_0_0_u" );
	var szparam = queryString.parse("?type=s&sortType=C&sortRule=-1&pageSize=10&page=1&jsName=quote_sza&style=20");
	var szmodel = new Model(szparam , szview );
	szmodel.lazyElem = szview.container;
	
	var sztab = new TabView();
	var sztimerindex = upatetimer.add(szmodel);
	sztab.tabs = mini("#sztab li");
	sztab.panels = mini("#szpanels .tab-panel");
	sztab.init("click", "current");
	sztab.onchange = function(i){
		var action = "tab-" + (2 + i);
		controll[action]();
		
		szmodel.lazyElem = szmodel.view.container;
	    upatetimer.set(sztimerindex, szmodel);
		
	};
	
	var controll = {
		
		"init": function(){
			//shmodel.load();
			//szmodel.load();		
			lazys.push(shmodel);
			lazys.push(szmodel);
			
		},
		
		//沪A涨幅
		"tab-0": function(){
			shmodel.view.container = mini("#SHUP")[0];
			shmodel.view.sortRule = -1;
			shmodel.view["icon-change"] = "icon-change-up";
			shmodel.view["hashkey"] =  "10_0_0_u";
			shmodel.param["sortRule"] = -1;
			shmodel.load();
			
			shheader.render({ hashkey: "10_0_0_u", sortRule: -1, name: "沪A" });
		},
		
		//沪A跌幅
		"tab-1": function(){
			shmodel.view.sortRule = 1;
			shmodel.view["icon-change"] = "icon-change-down";
			shmodel.view["hashkey"] =  "10_0_0_d";
			shmodel.view.container = mini("#SHDOWN")[0];
			shmodel.param["sortRule"] = 1;
			shmodel.load();
			
			shheader.render({ hashkey: "10_0_0_d", sortRule: 1, name: "沪A" });
		},
		
		//深圳A涨幅
		"tab-2": function(){
			szmodel.view["sortRule"] = -1;
			szmodel.view["icon-change"] = "icon-change-up";
			szmodel.view["hashkey"] =  "20_0_0_u";
			szmodel.view["container"] = mini("#SZUP")[0];
			szmodel.param["sortRule"] = -1;
			szmodel.load();
			
			szheader.render({ hashkey: "20_0_0_u", sortRule: -1, name: "深A" });
		},
		
		//深圳A跌幅
		"tab-3": function(){
			szmodel.view["sortRule"] = 1;
			szmodel.view["icon-change"] = "icon-change-down";
			szmodel.view["hashkey"] =  "20_0_0_d";
			szmodel.view["container"] = mini("#SZDOWN")[0];
			szmodel.param["sortRule"] = 1;
			szmodel.load();
			
			szheader.render({ hashkey: "20_0_0_d", sortRule: 1, name: "深A" });
		}		
	};
	controll["init"]();

	
}());


//板块排行
(function() {
	//2012-12-19 板块接口更改静态数据源
	
	var staticdata = {
		
	    //行业涨幅
	    "2_-1": "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C._BKHY&sty=FCCS&st=c&p=1&ps=10&sr=-1&cb=&js=var%20BKtrade%20={Trade:[[(x)]]}&token=d0075ac6916d4aa6ec8495db9efe7ede",
		
		//行业跌幅
		"2_1": "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C._BKHY&sty=FCCSL&st=c&p=1&ps=10&sr=1&cb=&js=var%20BKtrade%20={Trade:[[(x)]]}&token=d0075ac6916d4aa6ec8495db9efe7ede",
		
		//概念涨幅
		"3_-1": "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C._BKGN&sty=FCCS&st=c&p=1&ps=10&sr=-1&cb=&js=var%20BKnotion%20={Notion:[[(x)]]}&token=d0075ac6916d4aa6ec8495db9efe7ede",
		
		//概念跌幅
		"3_1": "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C._BKGN&sty=FCCSL&st=c&p=1&ps=10&sr=1&cb=&js=var%20BKnotion%20={Notion:[[(x)]]}&token=d0075ac6916d4aa6ec8495db9efe7ede",
	};
	
    function Model(view, query) {
        this.view = view;
        if (query) {
            this.param = queryString.parse(query);
        }
    }

    Model.prototype = {

        param: queryString.parse("?type=2&size=5&orderType=0&jsName=BKtrade&sortRule=-1"),

        charset: "gb2312",

        init: function() {

        },

        onloaded: function(data) {
            var i = this.param["sortRule"] == -1 ? 0 : 1;
            var type = [];
            type["1"] = "Area";
            type["2"] = "Trade";
            type["3"] = "Notion";
            this.view.render(data[type[this.param["type"]]][0]);
        },

        load: function() {
            var _this = this;
				
			if( !staticdata[_this.param.type + "_" + _this.param.sortRule]) return;
			
            url = staticdata[_this.param.type + "_" + _this.param.sortRule];
            ajax.getScript(url, _this.charset, function() {
				//console.log(url)										
                _this.onloaded(window[_this.param.jsName]);
            });
        },

        update: function() {
            if (quote.HSOpening) {
                this.load();
            }
        }
    };

    function Header(moreID) {
        this.moreID = moreID;
    }

    Header.prototype = {

        moreID: "",

        data: {

            type: "trade",

            sortRule: "-1"

        },

        template: {

            more: '<a href="' + portalurl + 'stockeast/bklist#{$type}_0_0?sortRule={$sortRule}" target="_self">更多</a>'

        },

        replace: function(tmpl) {

            return tmpl.replace(/\{\$type\}/g, this.data.type).
							 replace(/\{\$sortRule\}/g, this.data.sortRule);
        },

        render: function(data) {

            this.data = data;
            mini(this.moreID)[0].innerHTML = this.replace(this.template.more);
        }
    };

    function View(container) {
        this.container = container || View.prototype.container;
    }

    function bkidpad(num, n) {
        y = '000' + num;
        return y.substr(y.length - n);
    }

    View.prototype = {

        type: 2,

        container: mini("#HYBKUP")[0],

        template: {

            header: '<table class="data-table" width="100%">' +
           '<tr>' +
             '<th>排名</th>' +
             '<th>板块名称</th>' +
             '<th>相关资讯</th>' +
             '<th>涨跌幅</th>' +
             '<th>成交量</th>' +
             '<th>换手率</th>' +
             '<th>上涨家数</th>' +
             '<th>下跌家数</th>' +
             '<th>涨跌股票</th>' +
             '<th>涨跌幅</th>' +
           '</tr>',

            repeatItem: '<tr>' +
						  '<td>{$increment}</td>' +
						  '<td><a href="'+portalurl+'stockeast/marketlist#2800{$xxlb}{$xxcode}_0_2" target="_self">{$data[2]}</a></td>' +
						  '<td>' +
						  		'{$yb}' +
						  		'<a href="http://data.eastmoney.com/bkzj/{$xxcode}.html" target="_self">资金流</a>' +
						  		'{$guba}' +
							'</td>' +
						  '<td><span class="{$bkcss}">{$data[3]}</span></td>' +
						  '<td><span class="digi">{$data[10]}</span></td>' +
						  '<td><span class="digi">{$data[4]}</span></td>' +
						  '<td><span class="digi red">{$szjs}</span></td>' +
						  '<td><span class="digi green">{$xdjs}</span></td>' +
						  '<td><a href="'+portalurl+'stockeast/detail?stockCode={$data[6]}" target="_self">{$data[8]}</a></td>' +
						  '<td><span class="{$stockcss}">{$data[9]}</span></td>' +
						'</tr>',

            footer: '</table>'
        },

        render: function(dt) {

            var container = this.container,
				headerhtml = this.template.header,
				rowhtml = this.template.repeatItem,
				footerhtml = this.template.footer;

            var repeater = new Repeater(headerhtml, rowhtml, footerhtml);
            var dataRow = [];
            var guba = "", zjl = "";


            for (var i = 0, n = dt.length; i < n; i++) {
                dataRow = dt[i].split(",");
                if (dataRow.length < 7)continue;
                repeater.set("data", dataRow);
                if (dataRow[3]&&dataRow[3] != "-") {
                    var bkcss = +dataRow[3].replace('%', '') > 0 ? 'digi-up' : (+dataRow[3].replace('%', '') < 0 ? 'digi-down' : '');
                    repeater.set("bkcss", bkcss);
                }
                repeater.set("prefix", ((quote.getMarkesBycode(dataRow[6]) == "1") ? "sh" : "sz"));
                var xxcode = dataRow[1].substr(3);
                repeater.set("xxcode", xxcode);
                repeater.set("xxlb", this.type);
                var zdpjs = dataRow[5].split("|");
                repeater.set("szjs", zdpjs[0]);
                repeater.set("xdjs", zdpjs[2]);
                var stockcss = +dataRow[9].replace('%', '') > 0 ? 'digi-up' : (+dataRow[9].replace('%', '') < 0 ? 'digi-down' : '');
                repeater.set("stockcss", stockcss);

                if (this.type == 2) {
                    guba = ' <a href="http://guba.eastmoney.com/list,bk' + bkidpad(xxcode, 4) + '.html"  target="_blank">股吧</a>';
                    yb = '<a href="http://data.eastmoney.com/report/' + xxcode + 'yb.html" target="_blank">研报</a> ';
                } else if (this.type == 3) {
                    guba = ' <a href="http://guba.eastmoney.com/list,bk' + bkidpad(xxcode, 4) + '.html"  target="_blank">股吧</a>';
                    yb = "";
                } else {
                    guba = "";
                    yb = "";
                }

                repeater.set("yb", yb);
                repeater.set("guba", guba);
                repeater.parse();
            }
            container.innerHTML = repeater.toHTML();
        }
    };

    var hyheader = new Header("#hymore");
    var hyview = new View();
    var hymodel = new Model(hyview);
    hymodel.lazyElem = hyview.container;

    var gnheader = new Header("#gnmore");
    var gnview = new View(mini("#GNBKUP")[0]);
    gnview.type = 3;

    var gnmodel = new Model(gnview, "?type=3&size=10&orderType=0&jsName=BKnotion&sortRule=-1");
    gnmodel.lazyElem = gnview.container;

    var control = {

        init: function() {
            lazys.push(hymodel);
            //hymodel.load();
            hyheader.render({ type: "trade", sortRule: 0 });

            lazys.push(gnmodel);
            //gnmodel.load();
            gnheader.render({ type: "notion", sortRule: 0 });
        },

        "tab-0": function() {
            hymodel.view["type"] = 2;
            hymodel.view["container"] = mini("#HYBKUP")[0];
            hymodel.param["sortRule"] = -1;
            hymodel.load();

            hyheader.render({ type: "trade", sortRule: 0 });
        },

        "tab-1": function() {
            hymodel.view["type"] = 2;
            hymodel.view["container"] = mini("#HYBKDOWN")[0];
            hymodel.param["sortRule"] = 1;
            hymodel.load();

            hyheader.render({ type: "trade", sortRule: 1 });
        },

        "tab-2": function() {

            gnmodel.view["type"] = 3;
            gnmodel.view["container"] = mini("#GNBKUP")[0];
            gnmodel.param["sortRule"] = -1;
            gnmodel.load();

            gnheader.render({ type: "notion", sortRule: 0 });
        },

        "tab-3": function() {
            gnmodel.view["type"] = 3;
            gnmodel.view["container"] = mini("#GNBKDOWN")[0];
            gnmodel.param["sortRule"] = 1;
            gnmodel.load();

            gnheader.render({ type: "notion", sortRule: 1 });
        }


    };
    var gntimer = upatetimer.add(gnmodel);
    var hytimer = upatetimer.add(hymodel);

    var hytab = new TabView();
    hytab.tabs = mini("#hybk li");
    hytab.panels = mini("#hybkpanels .tab-panel");
    hytab.init("click", "current");
    hytab.onchange = function(i) {
        var action = "tab-" + i;
        control[action]();
        hymodel.lazyElem = hymodel.view.container;
        upatetimer.set(hytimer, hymodel);

    };

    var gntab = new TabView();
    gntab.tabs = mini("#gnbk li");
    gntab.panels = mini("#gnbkpanels .tab-panel");
    gntab.init("click", "current");
    gntab.onchange = function(i) {
        var action = "tab-" + (2 + i);
        control[action]();

        gnmodel.lazyElem = gnmodel.view.container;
        upatetimer.set(gntimer, gnmodel);
    };
    control["init"]();
} ());


//全球股市
//图片
(function(){
	var indexList = ["NKY_UIFO", "KOSPI_UIFO", "INDU_UIFO", "CCMP_UIFO", "DAX_UIFO", "CAC_UIFO", "UKX_UIFO", "110000_UIFO", "0000011", "3990012"];
	var chart = "#globalstock img";

	var globalstock = new GlobalIndex(chart, indexList);
	globalstock.init();


	upatetimer.add(globalstock);
}());
	

//国际期货
(function() {
    var futureids = gjqh.split(",");
    var model = {

        url: "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=LCPS0,LZNS0,LALS0,LTNS0&sty=MPICFTC&st=z&sr=-1&p=1&ps=4&js=var%20quote_gj=[(x)]&token=7bc05d0d4c3c22ef9fca8c2a912d779c",

        charset: "utf-8",

        futures: futureids,

        onloaded: function(data) {

            view.render(data);
        },

        update: function() {

            this.load();
        },

        init: function() {

            //this.url += this.futures.join(",");
            //this.load();
        },

        load: function() {
            var _this = this;
            view.update();
            ajax.getScript(_this.url, _this.charset, function() {
                _this.onloaded(window["quote_gj"]);
            });
        }

    };

    var view = {

        chart: new ChartView(mini("#futures img")),

        container: document.getElementById("futurestable"),

        update: function() {
            view.chart.render();
        },

        template: {

            header: '<table width="100%"  class="data-table  collapse-top">' +
						'<tr>' +
						  '<th>代码</th>' +
						  '<th>品种</th>' +
						  '<th>最新价</th>' +
						  '<th>涨跌额</th>' +
						  '<th>涨跌幅</th>' +
						  '<th>今开</th>' +
						  '<th>最高</th>' +
						  '<th>最低</th>' +
						  '<th>昨结</th>' +
						  '<th>成交量(手)</th>' +
						  '<th>买量(手)</th>' +
						  '<th>卖量(手)</th>' +
						  '<th>持仓(手)</th>' +
						'</tr>',

            repeatItem: '<tr>' +
						  '<td><a href="http://quote.eastmoney.com/gjqh/{$dataRow[1]}.html" target="_blank">{$dataRow[1]}</a></td>' +
						  '<td><a href="http://quote.eastmoney.com/gjqh/{$dataRow[1]}.html" target="_blank">{$dataRow[2]}</a></td>' +
						  '<td><span class="{$tpriceCss}">{$dataRow[3]}</span></td>' +
						  '<td><span class="{$tchangeCss}">{$dataRow[4]}</span></td>' +
						  '<td><span class="{$tchangeCss}">{$dataRow[5]}</span></td>' +
						  '<td><span class="{$openCss}">{$dataRow[6]}</span></td>' +
						  '<td><span class="{$maxCss}">{$dataRow[7]}</span></td>' +
						  '<td><span class="{$minCss}">{$dataRow[8]}</span></td>' +
						  '<td><span class="digi">{$dataRow[9]}</span></td>' +
						  '<td><span class="digi">{$dataRow[10]}</span></td>' +
						  '<td><span class="digi">{$dataRow[11]}</span></td>' +
						  '<td><span class="digi">{$dataRow[12]}</span></td>' +
						  '<td><span class="digi">{$dataRow[14]}</span></td>' +
						'</tr>',

            footer: '</table>'
        },

        className : function(a, b) {
            a = Number(a);
            b = Number(b);
            if (a == 0)
                return "";
            if (arguments.length == 1) {
                if (isNaN(a)) return "";
                return a > 0 ? "red" : "green";
            }
            else {
                if (isNaN(a) || isNaN(b)) return "";
                if (a == b)
                    return "";
                else
                    return a > b ? "red" : "green";
            }
        },
        render: function(dt) {

            var container = this.container,
				headerhtml = this.template.header,
				rowhtml = this.template.repeatItem,
				footerhtml = this.template.footer;

            var repeater = new Repeater(headerhtml, rowhtml, footerhtml);
            var dataRow = [];
            for (var i = 0, n = dt.length; i < n; i++) {
                dataRow = dt[i].split(",");

                var tpriceCss = this.className(dataRow[5], dataRow[6]);
                var tchangeCss = this.className(dataRow[4]);
                var openCss = this.className(dataRow[10], dataRow[6]);
                var maxCss = this.className(dataRow[11], dataRow[6]);
                var minCss = this.className(dataRow[12], dataRow[6]);
                
                repeater.set("dataRow", dataRow);
                repeater.set("tpriceCss", tpriceCss);
                repeater.set("tchangeCss", tchangeCss);
                repeater.set("openCss", openCss);
                repeater.set("maxCss", maxCss);
                repeater.set("minCss", minCss);

                repeater.parse();
            }

            container.innerHTML = repeater.toHTML();
        }

    };

    var control = {

        index: "",

        "init": function() {
            //view.chart.render();
            model.init();
            model.lazyElem = document.getElementById("futures");//view.container;
            index = upatetimer.add(model);
            lazys.push(model);
        }

    };

    control["init"]();
} ());


dom(mini("#SortSubmit")[0]).on("click", function() {
    quote.queryTop(mini("#querytop")[0]);
});


lazyModel(lazys);
//定时刷新
upatetimer.start();

var sc = new  QCScroll(mini("#scrollNews")[0]);
sc.animate();

