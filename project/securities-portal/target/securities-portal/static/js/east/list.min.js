var viewstate = {};
Object.prototype.extend = function (object) {
    for (name in object) {
        // if (typeof (this.prototype[name]) === "undefined")
        //  if(object.hasOwnProperty(name))
        this[name] = object[name];
    }
    return this;
};

FixedTableHeader.init = function (template) {
    var forexTable = $("fixed");
    var brendnav = $("brendnav");
    if (forexTable) {
        var fixedTable = new FixedTableHeader(forexTable);
        DomEvent.addEvent(fixedTable.tableHeader, "click", function (e) {
            var target = DomEvent.getEventTarget();
            var type = template.getSortType(target);
            template._onSortting(type);
        });
    }
    else {
        FixedTableHeader.clear();
    }
    window.scroll(0, 0);
};
/**/
PageNavigation.prototype.setPageCount = function (num) {
    this.pagecount = num;
};
PageNavigation.prototype.CreatePageNav = function (n) {
    this.nav(n);
    this.render();
};
PageNavigation.prototype.pageChange = new Function();
//====兼容函数
function getHash(url) {
    var hash = url || window.location.hash;
    var ret = /#((?:[\w,\.])+)/.exec(hash);
    var state = (ret != null) ? RegExp.$1 : "";
    return state;
}

var $ = function (id) {
    return "string" == typeof id ? document.getElementById(id) : id;
};

var Utility = utils;
//JsLoader
var JsLoader = {
    load: ajax.getScript
};

var JSTemplate = Repeater;

var Quote = {};
Quote.Tool = new function () {
    //涨跌的class
    this.className = function (a, b) {
        var _a = new String(a);
        if (_a.indexOf('千') > 0 || _a.indexOf('万') > 0 || _a.indexOf('亿') > 0) {
            a = _a.replace('千', "").replace('万', "").replace('亿', "");
        }
        a = Number(a);
        if (a == 0)
            return "";
        if (arguments.length == 1) {
            if (isNaN(a)) return "digi";

            return a > 0 ? "digi-up" : "digi-down";
        }
        else {
            var _b = new String(b);
            if (_b.indexOf('千') > 0 || _b.indexOf('万') > 0 || _b.indexOf('亿') > 0) {
                b = _b.replace('千', "").replace('万', "").replace('亿', "");
            }
            b = Number(b);
            if (isNaN(a) || isNaN(b)) return "digi";
            if (a == b)
                return "digi";
            else
                return a > b ? "digi-up" : "digi-down";
        }
    };
};

var Gif = TextGif;


function ConfigArgs() {
    if ($("config.style")) {
        this.style = $("config.style").value;
    }
    if ($("config.style")) {
        this.sortType = $("config.sortType").value;
    }
    if ($("config.sortRule")) {
        this.sortRule = $("config.sortRule").value;
    }
}
//更新图片
function updateImage(img) {
    var re = /rt=([\d\.]+)(?:&|$)/
         , matchs = re.exec(img.src)
         , rt = Math.random()
         , src = img.src;
    if (matchs) {
        rt = matchs[0].replace(matchs[1], rt);
        img.src = src.replace(re, rt);
    } else {
        rt = "rt=" + rt;
        img.src = src + (src.indexOf("?") !== -1 ? "&" : "?") + rt;
    }
}


//数据对象
function TreeItem(classid, data, optid, query, subclass) {
    this.classid = classid;
    this.data = data;
    this.optid = optid;
    this.query = query;
    this.subclass = subclass;
}

//数据对象
function IDataModel(ds, args, sortDataDic) {
    this.ds = ds; //:DataService
    this.args = args; //:UpdataArgs
    this.sortDataDic = sortDataDic || {};
}
IDataModel.DefaultVaule = {
    updataArgs: {
        interval: 6000,
        delegate: function () {
            return quote.HSOpening;
        }
    },
    sortDataDic: {
        A: 1,
        B: 5,
        C: 11,
        D: 10,
        E: 8,
        F: 9,
        //  G 五分钟涨跌幅
        H: 22, //量比
        I: 24, //静态市盈率
        J: 23 //换手
    }
};
function HKDataModel(sortType, sortRule, pageSize, style) { //港股
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C._HKS&sty=FCOQB&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";

    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 6000,
        delegate: function () {
            return quote.HKOpening;
        }
    };
    IDataModel.call(this, ds, updataArgs);
}
function NHKDataModel(sortType, sortRule, pageSize, style) {//新港股(沪港通)
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C." + style + "&sty=CTF&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 6000,
        delegate: function () {
            return quote.HKOpening;
        }
    };
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//港股指数数据源
function HKZSDataModel(sortType, sortRule, pageSize, style) { //港股
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C.HKIN&sty=FCOQB&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";

    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 6000,
        delegate: function () {
            return quote.HKOpening;
        }
    };
    IDataModel.call(this, ds, updataArgs);
}

//港股涡轮数据源
function HKWDataModel(sortType, sortRule, pageSize, style) { //港股
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C._HKW&sty=FCOQB&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";

    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 6000,
        delegate: function () {
            return quote.HKOpening;
        }
    };
    IDataModel.call(this, ds, updataArgs);
}

function NYSPGPQHDataModel(sortType, sortRule, pageSize, style) {//港交所衍生品
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C.HEX.HKSTOCKF&sty=FCHKEGL&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 15000,
        delegate: function () {
            return true;
        }
    };
    var sortDataDic = { "A": 1, "F": 3, "E": 4 };
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//港股指数期货
function ZSQHDataModel(sortType, sortRule, pageSize, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C.HEX.HKINDEXF&sty=FCHKEGL&sortType=(Volume)&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 15000,
        delegate: function () {
            return true;
        }
    };
    var sortDataDic = { "A": 1, "F": 3, "E": 4 };
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//互联网中国
function ItChinaDataModel() { //港股
    var host = "http://hq2gjqh.eastmoney.com/GlobalIndex/default.aspx";
    var params = "?type=itchina&dataName=UsStock&jsName=UsStockJs&jsSort=1&sortType=C&sortRule=-1";
    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 6000,
        delegate: function () {
            return true;
        }
    };

    var sortDataDic = { "A": 2, "B": 3, "C": 4, "D": 11 };

    IDataModel.call(this, ds, updataArgs, sortDataDic);
}

//人民币相关
function RMBDataModel(sortType, sortRule, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var cmd = "";
    if (style == "rmbxj") {
        cmd = "_CNYFOREX_I";
    } else if (style == "rmbjj") {
        cmd = "_CNYFOREX_B";
    } else if (style == "rmbforex") {
        cmd = "CNYOFFS";
    } else {
        cmd = "CNYRATE";
    }
    var params = "?type=CT&cmd=C." + cmd + "&sty=AMIC&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    var updataArgs = {
        interval: 15000,
        delegate: function () {
            return true;
        }
    };
    var sortDataDic = { "A": 1, "F": 3, "E": 4 };
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function HSDataModel(sortType, sortRule, pageSize, style) {//
    var host = "http://hqdigi2.eastmoney.com/EM_Quote2010NumericApplication/index.aspx";
    if (style == "285001") {
        //host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/index.aspx";
    }
    var params = "?type=s&sortType=" + sortType + "&sortRule=" + sortRule + "&pageSize=" + pageSize + "&page=1&jsName=quote_123&style=" + style + "&token=44c9d251add88e27b65ed86506f6e5da";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//A股
function ADataModel(sortType, sortRule, pageSize, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var cmd = "";
    switch (style) {
        case "33": //沪深A股
            cmd = "C._A";
            break;
        case "10": //沪A股
            cmd = "C.2";
            break;
        case "11": //沪B股
            cmd = "C.3";
            break;
        case "20": //深证A股
            cmd = "C._SZAME";
            break;
        case "21": //深证B股
            cmd = "C.7";
            break;
        case "27": //创业板
            cmd = "C.80";
            break;
        case "15": //上海指数
            cmd = "C.1";
            break;
        case "25": //深圳指数
            cmd = "C.5";
            break;
        case "14.1.1":
            cmd = "C._DEBT_SH_G";
            break;
        case "14.2.1":
            cmd = "C._DEBT_SH_Q";
            break;
        case "14.3":
            cmd = "C._DEBT_SH_Z";
            break;
        case "2850020":
            cmd = "C._DEBT_SH_H";
            break;
        case "24.1":
            cmd = "C._DEBT_SZ_G";
            break;
        case "24.2":
            cmd = "C._DEBT_SZ_Q";
            break;
        case "24.3":
            cmd = "C._DEBT_SZ_Z";
            break;
        case "2850021":
            cmd = "C._DEBT_SZ_H";
            break;
        case "285002":
            cmd = "C.__285002";
            break;
        case "2850013":
            cmd = "C.__2850013";
            break;
        case "2850014":
            cmd = "C.__2850014";
            break;
        case "2850022": //风险警示板
            cmd = "C._AB_FXJS";
            break;
        case "26": //中小板
            cmd = "C._ME";
            break;
        case "28003707": //沪股通
            cmd = "C.BK07071";
            break;
        case "28013804": //深股通
            cmd = "C.BK08041";
            break;
    default://板块概念
        cmd = "C.BK0" + style.substring(style.length - 3, style.length) + "1";
        break;
    }
    var params = "?type=CT&cmd=" + cmd + "&sty=FCOIATA&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//成分股列表
function CFGDataModel(sortType, sortRule, pageSize) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    
    var params = "?type=CT&cmd=C.IE.ALL&sty=FCOIATA&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//成分股详情
function CFGItemsDataModel(sortType, sortRule, pageSize, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";

    var params = "?type=CT&cmd=C.IE" + style + "&sty=FCOIATA&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}


function SBDataModel(sortType, sortRule, pageSize, style) {//三板
    var cmd;
    //新三板创新
    if (style == "44") {
        cmd = "C._81.32";
    } else if (style == "45") {//新三板基础
        cmd = "C._81.16";
    } else if (style == "43") { //全部
        cmd = "C._81.BASIC";
    } else {
        cmd = "R.__40|__42";
    }
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=" + cmd + "&sty=FCOIA&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function XGDataModel(sortType, sortRule, pageSize, style) {//新股
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C.__285001&sty=FCOIATA&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//ABH股数据源
function ABHDataModel(sortType, sortRule, pageSize, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var cmd = "";
    if (style == "absh") {
        cmd = "_ABPCSHZ";
    } else if (style == "ah" || style == "ah1") {
        cmd = "_AHH";
    } else {
        cmd = "_ABPCSZZ";
    }
    var params = "?type=CT&cmd=C." + cmd + "&sty=FCABHL&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

//function USDataModel(sortType, sortRule, pageSize, style) {
//    var host = "http://hq2gjgp.eastmoney.com/EM_Quote2010NumericApplication/Index.aspx";
//    var params = "?jsName=UsStockJs&dataName=rank&Type=s&style=" + style + "&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize;
//    var ds = new DataService(host + params);
//    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
//}

function USDataModel(sortType, sortRule, pageSize, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var cmd = "";
    if (style == "70") {//全部美股
        cmd = "_UN";
    } else if (style == "28CHINA") {//中国概念股
        cmd = "__28CHINA";
    } else if (style == "28CHINAINTERNET") {//互联网中国
        cmd = "__28CHINAINTERNET";
    } else if (style == "286") {//科技类
        cmd = "MK0216";
    } else if (style == "283") {//金融类
        cmd = "MK0217";
    } else if (style == "287") {//医药食品类
        cmd = "MK0218";
    } else if (style == "284") {//媒体类
        cmd = "MK0220";
    } else if (style == "281") {//汽车能源类
        cmd = "MK0219";
    } else {
        cmd = "MK0221";//制造零售类
    }
    var params = "?type=CT&cmd=C." + cmd + "&sty=MPICTTA&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&lvl=&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function FundDataModel(sortType, sortRule, style, pageSize) {
    var host = "http://hqdigi2.eastmoney.com/EM_Quote2010NumericApplication/index.aspx";
    var params = "?type=s&style=" + style + "&sortType=" + sortType + "&sortRule=" + sortRule + "&pageSize=" + pageSize + "&page=1&jsName=quote_data";
    var ds = new DataService(host + params);
    // if (style == "285002") {
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
    // } else {
    //     IDataModel.call(this, ds, null);
    // }
}

function BondIndexDataModel(sortType, sortRule) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=3994812,3950322,3950312,3950222,3950212,0000611,0000221,0000131,0000121&sty=MPICTTA&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=1000&lvl=&cb=&js=var%20quote_bondIndex%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_bondIndex";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function BondYhjDataModel(sortType, sortRule, pageSize, style) {//银行间
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var params = "?type=CT&cmd=C.IB&sty=FCIBBL&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_yhj%3d{rank:[(x)],pages:(pc)}&token=beb0a0047196124721f56b0f0ff5a27c&jsName=quote_yhj";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function BondDataModel(sortType, sortRule, pageSize, style) {
    var host = "http://hqdigi2.eastmoney.com/EM_Quote2010NumericApplication/index.aspx";
    var params = "?page=1&type=s&style=" + style + "&sortType=" + sortType + "&sortRule=" + sortRule + "&jsName=quote_bond&pageSize=" + pageSize;
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function ForexDataModel(sortType, sortRule, pageSize, style) {
    if (style == "28RMBRate") {
        var host = "http://hq2gjqh.eastmoney.com/EM_Futures2010NumericApplication/Index.aspx?jsName=fxrc&Type=S&SortType=A&pageSize=20&page=1&style=28RMBRate";
        var ds = new DataService(host);
        IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
    } else {
        var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
        var cmd = "";
        if (style == "1") {
            cmd = "C._FX_BASIC";
        } else if (style == "2") {
            cmd = "C._FX_CROSS";
        } else {
            cmd = "R._FX_BASIC|_FX_CROSS|_CNYFOREX_I|_CNYFOREX_B|CNYOFFS";
        }
        var params = "?type=CT&cmd=" + cmd + "&sty=AMIC&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=44c9d251add88e27b65ed86506f6e5da&jsName=quote_123";

        var ds = new DataService(host + params);
        IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
    }
}

function FuturesIndexDataModel(sortType, sortRule, pageSize, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";

    var code = "";
    if (style == "12.1.1") { //全部股指
        code = "_168_FO";
    } else if (style == "12") {//沪深300
        code = "_IF_FO";
    } else if (style == "12.1") {//上证50
        code = "_IH_FO";
    } else if (style == "12.2") {//中证500
        code = "_IC_FO";
    } else if (style == "13") {//5年国债
        code = "_TF_FO";
    } else if (style == "14") {//10年国债
        code = "_T_FO";
    }
    params = "?type=CT&cmd=C." + code + "&sty=FCFL4O&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function GJFuturesDataModel(sortType, sortRule, pageSize, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    params = "?type=CT&cmd=C._UF&sty=FCFL4O&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";
    var url = host + params;
    var ds = new DataService(url);
    var sortDataDic = {
        "A": 1, //代码
        "B": 3, //最新价
        "C": 4, //涨跌幅
        "D": 5, //涨跌额
        "E": 9, //成交量
        "F": 10, //买量
        "G": 11, //卖量
        "H": 12//持仓量
    };
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs, sortDataDic);
}

function FuturesDataModel(sortType, sortRule, style) {
    var host = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx";
    var array = style.split(",");
       if (array.length == 1) {
        var market = "";
        if (style == "11") {
            market = "SHFE"
        }else if (style == "3") {
            market = "DCE"
        } else if (style == "4") {
            market = "CZCE"
        } 
        params = "?type=CT&cmd=C." + market + "&sty=FCFL4O&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";
    } else {
        var newKey = this._getFuturesId(array);
        var params = "?type=CT&cmd=C." + newKey + "&sty=FCFL4O&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=" + pageSize + "&cb=&js=var%20quote_123%3d{rank:[(x)],pages:(pc)}&token=7bc05d0d4c3c22ef9fca8c2a912d779c&jsName=quote_123";
    }
    var ds = new DataService(host + params);
    var sortDataDic = {
        "A": 1, //代码
        "B": 5, //最新价
        "C": 18, //涨跌幅
        "D": 17, //涨跌额
        "E": 9, //成交量
        "F": 21, //买量
        "G": 22, //卖量
        "H": 16//持仓量
    };
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs, sortDataDic);
}

FuturesDataModel.prototype._getFuturesId = function (array) {

    var url = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C._F&sty=GBIDL&st=a&sr=&p=&ps=6666&cb=&js=(x)&token=de1161e2380d231908d46298ae339369";
  
    var jsy = array[2];
    var pz = array[1];

    var key = jsy + pz;
    var newKey = "";

    switch (key) {
        case "10":
            newKey = "F_SHFE_RB"; break; //螺纹钢
        case "11":
            newKey = "F_SHFE_WR"; break;//线材
        case "12":
            newKey = "F_SHFE_CU"; break;//铜
        case "13":
            newKey = "F_SHFE_AL"; break;//铝
        case "14":
            newKey = "F_SHFE_RU"; break;//天然橡胶
        case "15":
            newKey = "F_SHFE_FU"; break;//燃料油
        case "16":
            newKey = "F_SHFE_ZN"; break;//锌
        case "17":
            newKey = "F_SHFE_AU"; break;//黄金 
        case "18":
            newKey = "F_SHFE_PB"; break;//铅
        case "19":
            newKey = "F_SHFE_AG"; break;//白银
        case "110":
            newKey = "F_SHFE_BU"; break;//石油沥青
        case "111":
            newKey = "F_SHFE_HC"; break;//热轧卷板
        case "112":
            newKey = "F_SHFE_NI"; break;//镍
        case "113":
            newKey = "F_SHFE_SN"; break;//锡
        case "20":
            newKey = "F_DCE_M"; break;//豆粕
        case "21":
            newKey = "F_DCE_A"; break;//豆一
        case "22":
            newKey = "F_DCE_C"; break;//玉米
        case "23":
            newKey = "F_DCE_B"; break;//豆二
        case "24":
            newKey = "F_DCE_Y"; break;//豆油
        case "25":
            newKey = "F_DCE_L"; break;//乙烯
        case "26":
            newKey = "F_DCE_P"; break;//棕油
        case "27":
            newKey = "F_DCE_V"; break;//PVC
        case "28":
            newKey = "F_DCE_J"; break;//焦炭
        case "29":
            newKey = "F_DCE_JM"; break;//焦煤
        case "210":
            newKey = "F_DCE_I"; break;//铁矿石
        case "211":
            newKey = "F_DCE_JD"; break;//鸡蛋
        case "212":
            newKey = "F_DCE_BB"; break;//胶合板
        case "213":
            newKey = "F_DCE_FB"; break;//纤维板
        case "214":
            newKey = "F_DCE_PP"; break;//聚丙烯
        case "215":
            newKey = "F_DCE_CS"; break;//玉米淀粉
        case "30":
            newKey = "F_CZCE_WT"; break;//普麦
        case "31":
            newKey = "F_CZCE_WS"; break;//强麦
        case "32":
            newKey = "F_CZCE_CF"; break;//棉花
        case "33":
            newKey = "F_CZCE_SR"; break;//白砂糖
        case "34":
            newKey = "F_CZCE_TA"; break;//PTA
        case "35":
            newKey = "F_CZCE_RO"; break;//菜籽油
        case "36":
            newKey = "F_CZCE_ER"; break;//早籼稻
        case "37":
            newKey = "F_CZCE_ME"; break;//甲醇
        case "38":
            newKey = "F_CZCE_FG"; break;//玻璃
        case "39":
            newKey = "F_CZCE_RM"; break;//菜籽粕
        case "310":
            newKey = "F_CZCE_RS"; break;//油菜籽
        case "311":
            newKey = "F_CZCE_ZC"; break;//动力煤
        case "312":
            newKey = "F_CZCE_JR"; break;//粳稻
        case "313":
            newKey = "F_CZCE_LR"; break;//晚籼稻
        case "314":
            newKey = "F_CZCE_SF"; break;//硅铁
        case "315":
            newKey = "F_CZCE_SM"; break;//锰硅
        default:
    }
  
    return newKey;
};

function FuturesxhfyDataModel(sortType, sortRule, style) {
    var host = "http://hq2gnqh.eastmoney.com/EM_Futures2010NumericApplication/index.aspx";
    var params = "?Type=S&jsName=quote_futures&style=" + style + "&sortType=" + sortType + "&sortRule=" + sortRule + "&page=1&pageSize=20&reference=rtj&jsSort=1";
    var ds = new DataService(host + params);
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs);
}

function BTBFuturesDataModel() {
    var host = "http://hq2gjqh.eastmoney.com/EM_Futures2010NumericApplication/index.aspx";
    var params = "?type=z&jsName=quote_future&sortType=A&sortRule=1&jsSort=1&ids=";
    var url = host + params + "MtGox0,btstp0,btceB0,796f0,btcc0,btct0,chbtc0,fxbtc0,okcoin0,btc1000,huobi0,bter0,rmbtb0";
    var ds = new DataService(url);
    var sortDataDic = {
        "A": 1, //代码
        "B": 5 //最新价
    };
    IDataModel.call(this, ds, IDataModel.DefaultVaule.updataArgs, sortDataDic);
}

//处理页面逻辑
(function () {
    //获取数据
    var quoteDs, _this;
    function Presenter(view) {
        _this = this;
        _this.view = view;
        onViewSet();
    }

    function onViewSet() {
        var view = _this.view;
        var dataModel = getDataModel(view);
        view.template = selectTemplate();
        if (view.template == undefined) return;
        setFeatures(view.template);
        view.init(dataModel.ds, dataModel.args, dataModel.sortDataDic);
    }

    function selectTemplate() {
        var position = viewstate["tree-extend-position"],
            name = viewstate["style"],
            sub = viewstate["tree-sub-position"];
        var map = new TemplateMap(_this.view);
        var template = map.getTemplate(position, sub, name);
        if (typeof template === "function") {
            template = template();
        }
        return template;
    }

    function setFeatures(template) {
        if (template.sortAble) {
            template.sortAble(quoteDs.parameters.jsSort);
            template.sortingEvent = sortingEventHanel;
            template.setSortFiled(quoteDs.parameters.sortType, quoteDs.parameters.sortRule);
        }
        if (template.selectChangeAble) {
            template.selectChangeAble();
        }

    }
    function ModelMap(sortType, sortRule, pageSize, style) {
        ModelMap["default"] = function () {
            return new ADataModel(sortType, sortRule, pageSize, style);
        };

        this.map = [
        {
            "285001": function() {
                return new XGDataModel(sortType, sortRule, pageSize, style);
            },
            "_0_3": function() {
                return new SBDataModel(sortType, sortRule, pageSize, style);
            },
            "_0_4": function() {
                return new ABHDataModel(sortType, sortRule, pageSize, style);
            },
            "35": function() {
                return new CFGDataModel(sortType, sortRule, pageSize);
            },
            "_0_6": function() {
                return new CFGItemsDataModel(sortType, sortRule, pageSize, style);
            }
        },
        {
            "ah": function() {
                return new ABHDataModel(sortType, sortRule, pageSize, style);
            },
            "mk0141": function() {
                return new NHKDataModel(sortType, sortRule, pageSize, style);
            },
            "mk0142": function() {
                return new NHKDataModel(sortType, sortRule, pageSize, style);
            },
            "mk0146": function () {
                return new NHKDataModel(sortType, sortRule, pageSize, style);
            },
            "mk0144": function() {
                return new NHKDataModel(sortType, sortRule, pageSize, style);
            },
            "yspgpqh": function() {
                return new NYSPGPQHDataModel(sortType, sortRule, pageSize, style);
            },
            "zsqh": function() {
                return new ZSQHDataModel(sortType, sortRule, pageSize, style);
            },
            "32": function() {
                return new HKZSDataModel(sortType, sortRule, pageSize, style);
            },
            "52": function() {
                return new HKWDataModel(sortType, sortRule, pageSize, style);
            },
            "default": function() {
                return new HKDataModel(sortType, sortRule, pageSize, style);
            }
        },
		{
		    "itchina": function () {
		        return new ItChinaDataModel();
		    },
		    "default": function () {
		        return new USDataModel(sortType, sortRule, pageSize, style);
		    }
		},
        {
            "default": function() {
                return new SBDataModel(sortType, sortRule, pageSize, style);
            }
        },
		{
		    "defualt": function () {
		        return new FundDataModel(sortType, sortRule, style, pageSize);
		    }
		},
		{
		    "12.1.1": function () {
		        return new FuturesIndexDataModel(sortType, sortRule, pageSize, style);
		    },
		    "12.1": function () {
		        return new FuturesIndexDataModel(sortType, sortRule, pageSize, style);
		    },
		    "12.2": function () {
		        return new FuturesIndexDataModel(sortType, sortRule, pageSize, style);
		    },
		    "12": function () {
		        return new FuturesIndexDataModel(sortType, sortRule, pageSize, style);
		    },
		    "13": function () {
		        return new FuturesIndexDataModel(sortType, sortRule, pageSize, style);
		    },
		    "14": function () {
		        return new FuturesIndexDataModel(sortType, sortRule, pageSize, style);
		    },
		    "gjqh": function () {
		        return new GJFuturesDataModel(sortType, sortRule, pageSize, style);
		    },

		    "default": function () {
		        return new FuturesDataModel(sortType, sortRule, style);
		    }
		},
        {
            "rmbxj": function () {
                return new RMBDataModel(sortType, sortRule, style);
            },
            "rmbjj": function () {
                return new RMBDataModel(sortType, sortRule, style);
            },
            "rmbforex": function () {
                return new RMBDataModel(sortType, sortRule, style);
            },
            "rmbzjj": function () {
                return new RMBDataModel(sortType, sortRule, style);
            },
            "default": function() {
                return new ForexDataModel(sortType, sortRule, pageSize, style);
            }
        },
		{
		    "1,7,1": function () {
		        return new FuturesDataModel(sortType, sortRule, style);
		    }
		},
		{
		    "bondIndex": function () {
		        return new BondIndexDataModel(sortType, sortRule);
		    },
		    "yhj": function () {
		        return new BondYhjDataModel(sortType, sortRule, pageSize, style);
		    },
		    "defualt": function () {
		        return new BondDataModel(sortType, sortRule, pageSize, style);
		    }
		},
		{
		    "31.2": function () {
		        return new FuturesxhfyDataModel(sortType, sortRule, style);
		    },
		    "default": function () {
		        return new SBDataModel(sortType, sortRule, pageSize, style);
		    }
		},
		{
		    "btb": function () {
		        return new BTBFuturesDataModel(style);
		    }
		}, undefined,
		{
		    "ah": function () {
		        return new ABHDataModel(sortType, sortRule, pageSize, style);
		    },
		    "28003707": function () {
		        return new ADataModel(sortType, sortRule, pageSize, style);
		    },
		    "28013804": function () {
		        return new ADataModel(sortType, sortRule, pageSize, style);
		    },
		    "mk0144": function () {
		        return new NHKDataModel(sortType, sortRule, pageSize, style);
		    },
		    "mk0146": function () {
		        return new NHKDataModel(sortType, sortRule, pageSize, style);
		    },
		    "yspgpqh": function () {
		        return new NYSPGPQHDataModel(sortType, sortRule, pageSize, style);
		    }
		}
        ];
    }

    ModelMap.prototype = {

        getDataModel: function (id, sub, name) {
            var maps = this.map;
            var key = "_" + id + "_" + sub;
            var model = maps[id][name] || maps[id][key] || maps[id]["default"];
            return (model !== undefined) ? model() : ModelMap["default"]();
        }
    };


    //#key_p1_p2
    function getDataModel(view) {
        var sortType = viewstate["sortType"];
        var sortRule = viewstate["sortRule"];
        var style = viewstate["style"];
        var pageSize = view.pageSize;
        var positon = viewstate["tree-extend-position"];
        var sub = viewstate["tree-sub-position"];
        /*2012/4/20*/
        var modelMap = new ModelMap(sortType, sortRule, pageSize, style);
        var model = modelMap.getDataModel(positon, sub, style);
        quoteDs = model.ds;
        return model;
    }

    //更新页数据
    function update(n) {
        quoteDs.parameters.page = n || quoteDs.parameters.page;
        this.view.bind(quoteDs);
    }

    function sort(sortType, sortRule, sortcomplete) {
        quoteDs.parameters.sortRule = sortRule;
        quoteDs.parameters.sortType = sortType;
        quoteDs.parameters.page = 1;
        this.view.bind(quoteDs, sortcomplete);
    }

    function getSortRule(sortType) {
        var sortRule;
        var parameters = quoteDs.parameters;
        if (typeof parameters.sortType == "undefined") return;
        if (parameters.sortType == sortType) {
            sortRule = parameters.sortRule == "1" ? "-1" : "1";
        }
        else {
            sortRule = -1;
        }
        return sortRule;
    }

    function updateUrl(page, sortType, sortRule) {
        var url = location.href;
        url = url.replace(/page=(\d+)/ig, "page=" + page);
        url = url.replace(/sortType=(\w)/ig, "sortType=" + sortType);
        url = url.replace(/sortRule=(\-?1)/ig, "sortRule=" + sortRule);
        location.href = url;
    }

    function sortingEventHanel(sender, sortType) {
        if (sortType == "") return false;
        var sortRule = _this.getSortRule(sortType);
        sender.setSortFiled(sortType, sortRule);
        _this.view.pageWrapper.CreatePageNav(1);
        _this.sort(sortType, sortRule, sender.sortcomplete);
        updateUrl(1, sortType, sortRule);
    }

    Presenter.prototype.update = update;
    Presenter.prototype.getSortRule = getSortRule;
    Presenter.prototype.sort = sort;
    window.Presenter = Presenter;
})();

//设置频道链接
function setChannelLinks() {
    var hkLinkHTML = '<a target="_blank" href="http://hk.eastmoney.com/">点击进入港股频道</a> <a target="_blank" href="http://hk.eastmoney.com/hold.html">机构持仓</a> ';
    var xinguLinkHTML = '<a target="_blank" href="http://stock.eastmoney.com/newstock.html">点击进入新股频道</a> <a target="_blank" href="http://data.eastmoney.com/xg/xg/default.html">新股申购中签</a> '; //285001
    var forexLinkHTML = '<a target="_blank" href="http://forex.eastmoney.com/">点击进入外汇频道</a> <a href="http://quote.eastmoney.com/center/forexlist.html#3_6" target="_blank">外汇牌价</a> ';
    var changyebanLinkHTML = '<a target="_blank" href="http://stock.eastmoney.com/chuangyeban.html">点击进入创业板频道</a> ';
    var fundLinkHTML = '<a target="_blank" href="http://fund.eastmoney.com/">点击进入基金频道</a> <a target="_blank" href="http://fund.eastmoney.com/data/funddaogou.html">基金导购</a> ';
    var bondLinkHTML = '<a target="_blank" href="http://bond.eastmoney.com/">点击进入债券频道</a>';
    var usaLinkHTML = '<a target="_blank" href="http://stock.eastmoney.com/america.html">点击进入美股频道</a>';
    var ifLinkHTML = '<a target="_blank" href="http://stock.eastmoney.com/gzqh.html">点击进入股指期货频道</a> <a target="_blank" href="http://data.eastmoney.com/IF/Data/Contract.html">持仓龙虎榜</a> ';
    var if2LinkHTML = '';//国债期货
    var warrantLinkHTML = '<a target="_blank" href="http://stock.eastmoney.com/warrant.html">点击进入权证频道</a> ';
    var bguLinkHTML = '<a target="_blank" href="http://stock.eastmoney.com/bgu.html">点击进入B频道</a> <a target="_blank"  href="http://data.eastmoney.com/bgxx/hab.html">AB股比价</a>';
    var channelLink = document.getElementById("channellink");
    document.getElementById("refresh").className = "btn-refresh";
    if (!channelLink) return;
    var style = viewstate["style"];
    var position = viewstate["tree-extend-position"];
    channelLink.innerHTML = "<span></span>";//ie 高度 haslayout 空内容元素高度
    if (position == 1) {//港股
        channelLink.innerHTML = hkLinkHTML;
        if (style == "50" || style == "28HSCI" || style == "28HSCCI" || style == "28HSCIINDEX" || style == "28HSCEI" || style == "28HSCEIINDEX" || style == "28GEM" || style == "52") {
            document.getElementById("refresh").className = "btn-refresh red";
        }
    } else if (style == "forex") {//外汇
        channelLink.innerHTML = forexLinkHTML;
    } else if (style == "12" && position == 5) {// 股指期货
        channelLink.innerHTML = ifLinkHTML;
    } else if (style == "13" && position == 5) {// 国债期货
        channelLink.innerHTML = if2LinkHTML;
    } else if (style == "12" && position == 0) {// 权证
        channelLink.innerHTML = warrantLinkHTML;
    } else if (position == 4) {//基金
        channelLink.innerHTML = fundLinkHTML;
    } else if (position == 8) {//债券
        channelLink.innerHTML = bondLinkHTML;
    } else if (position == 2) {//美股
        channelLink.innerHTML = usaLinkHTML;
    }
}

function TemplateMap(view) {
    var maps = [
        {
            "285001": view.xgTemplate,
            "_0_1": view.indexTemplate,
            "_0_3": view.sanbanTemplate,
            "_0_4": view.abTemplate,
            "_0_6": view.xgTemplate,
            "35": view.cfgTemplate,
            "default": view.newHSTemplate
        },
        {
            "ah": view.ahTemplate,
            "32": view.hkIndexTemplate,
            "52": view.wolunTemplate,
            "mk0141": view.nhkTemplate,
            "mk0142": view.nhkTemplate,
            "mk0144": view.nhkTemplate,
            "yspgpqh": view.nyspgpqhTemplate,
            "zsqh": view.zsqhTemplate,
            "default": view.hkTemplate
        },
        {
            "itchina": view.itchinaTemplate,
            "default": view.usTemplate
        },
       {
           "default": view.sanbanTemplate
       },
        {
            "_4_0": view.fundTemplate,
            "default": view.sanbanTemplate
        },
        {
            "12.1.1": view.futuresTemplate_gzqh,
            "12": view.futuresTemplate_gzqh,
            "12.1": view.futuresTemplate_gzqh,
            "12.2": view.futuresTemplate_gzqh,
            "13": view.futuresTemplate_gzqh2,
            "14": view.futuresTemplate_gzqh3,
            "gjqh": view.newFuturesTemplate,
            "default": view.newFuturesTemplate
        },

        {
            "rmbzjj": view.forexMiddleTemplate,
            "rmbxj": view.newRMBTemplate,
            "rmbjj": view.newRMBTemplate,
            "rmbforex": view.newRMBTemplate,
            "28RMBRate": view.forexTemplate,
            "default": view.newRMBTemplate
        }
    ];

    maps[7] = {
        "1,7,1": view.newFuturesTemplate
    };

    maps[8] = {
        bondIndex: view.bondIndexTemplate,
        "yhj": view.bondYhjTemplate,
        "default": view.bondTemplate
    };
    maps[9] = {
        "31.2": view.futuresTemplate_xhfy,
        "default": view.sanbanTemplate
    };
    maps[10] = {
        "btb": view.futuresTemplate_btb
    };
    maps[11] = undefined;
    maps[12] = {
        "ah": view.ahTemplate,
        "28003707": view.newHSTemplate,
        "28013804": view.newHSTemplate,
        "mk0144": view.nhkTemplate,
        "mk0146": view.nhkTemplate,
        "yspgpqh": view.nyspgpqhTemplate
    };

    this.getTemplate = function (id, sub, name) {
        var key = "_" + id + "_" + sub;
        var template = maps[id][name] || maps[id][key] || maps[id]["default"];
        return template;
    };
}


//给grid添加自定义指标项功能
function SelectWrapper(template) {
    this.extend(template);
}
SelectWrapper.prototype = {
    selectChangeAble: function () {
        var _this = this;
        var opts = _this.opts;
        var $select = document.getElementById("change");
        if (!$select) { return; }
        $select.options.length = 0;
        for (var i = 0; i < opts.length; i++) {
            $select.options.add(new Option(opts[i][0], opts[i][1]));
        }
        $select.onchange = function () {
            var option = this.options[this.selectedIndex];
            _this.onSelectChange(option);
        };
        _this._init($select);
    },
    _init: function ($select) {
        var _this = this;
        var sortmap = {
            G: { text: "5分钟涨跌", value: "{$dataRow[21]}" },
            H: { text: "量比", value: "{$dataRow[22]}" },
            I: { text: "市盈率", value: "{$dataRow[24]|peRation}" },
            J: { text: "换手率", value: "{$dataRow[23]}" }
        };
        var option = sortmap[_this.sortType] || sortmap["G"];
        var options = $select.options;
        var selectInex;
        for (var i = 0; i < $select.options.length; i++) {
            if (option.value === options[i].value) {
                selectInex = i;
            }
        }
        this._setColumn(option.text, option.value);
        $select.selectedIndex = selectInex;

        // var selectInex_SortType = { G: 3, H: 2, I: 1, J: 0 }; //select中option元素下标和排序值的对应关系
        //var selectInex = selectInex_SortType[_this.sortType] !== undefined ? selectInex_SortType[_this.sortType] : 3;
        //if (selectInex) {
        //$select.selectedIndex = selectInex;
        //this._setColumn($select.options[selectInex].text, $select.options[selectInex].value);
        //}
    },
    _setColumn: function (name, tag) {
        var _this = this;
        var index = _this.selectColumn; //当切换Select需要改变的列在数组中的索引;
        var dynamicth = _this.header[index];
        var dynamictd = _this.row[index];
        var newth = "<th><a>" + name + "</a></th>";
        var newtd = "<td><span>" + tag + "</span></td>";
        _this.header[index] = newth;
        _this.row[index] = newtd;
        _this.tpl.header = _this.tpl.header.replace(dynamicth, newth);
        _this.tpl.row = _this.tpl.row.replace(dynamictd, newtd);
    },
    onSelectChange: function (option) {
        var _this = this;
        var index = _this.selectColumn;
        _this._setColumn(option.text, option.value);
        if (_this.sortFiledDic[_this.sortType] != index) {
            _this.render(cache, viewstate["parameters"]);
        } else {
            //如果切换的列是当前排序列执行排序操作
            _this._onSortting(_this.sortTypeDic[option.text][1]);
        }
    }
};

//给grid添加支持排序排序功能的类
function SortWrapper(grid) {
    this.extend(grid);
}
SortWrapper.prototype = {
    sortAble: function (jsSort) {
        var _this = this,
            render;
        document.getElementById(_this.id).onclick = function () {
            //触发排序事件；
            var target = DomEvent.getEventTarget();
            var type = _this.getSortType(target);
            _this._onSortting(type);
        };

        _this.jsSortable = jsSort;
    },
    sortFiledDic: { "A": 1, "B": 3, "C": 5, "D": 4 },
    sortTypeDic: { "代码": [1, "A"], "最新价": [3, "B"], "涨幅": [5, "C"], "涨跌": [4, "D"] },
    setSortFiled: function (sortType, sortRule) {
        var sorttype_text = { G: "5分钟涨跌", H: "量比", I: "市盈率", J: "换手率" };
        var dic = this.sortFiledDic;
        var itemrow = this.row.slice();
        var header = this.header.slice();
        var n = dic[sortType];
        this.sortType = sortType;
        this.sortRule = sortRule;
        if (n == undefined) { return; }
        if (sorttype_text[sortType]) {
            header[n] = header[n].replace(/\<a\>[^<]+<\/a\>/ig, "<a>" + sorttype_text[sortType] + "</a>");
        }
        if (this.currentBgCss) {
            itemrow[n] = itemrow[n].replace("<td>", '<td class="' + this.currentBgCss + '">'); //当前列样式
        }
        if (sortRule == 1)
            header[n] = header[n].replace('</th>', '<b class="icon-change-down" /></th>');
        else
            header[n] = header[n].replace('</th>', '<b class="icon-change-up" /></th>');
        this.tpl.header = header.join("");
        this.tpl.row = itemrow.join("");
        viewstate["sortType"] = sortType;
        viewstate["sortRule"] = sortRule;
    },
    //js排序比较函数
    compareFunction: function (x, y) {
        var compare, v1, v2, rx, ry,
            datamap = this.sortDataDic,
            i = datamap[this.sortType];
        rx = String(x).split(",");
        ry = String(y).split(",");
        v1 = parseFloat(rx[i]);
        v2 = parseFloat(ry[i]);

        //12.22处理字符串比较IE BUG
        if (isNaN(v1) || isNaN(v2)) {
            v1 = rx[i];
            v2 = ry[i];
        }
        if (v1 > v2) {
            compare = 1;
        } else if (v1 < v2) {
            compare = -1;
        } else {
            compare = 0;
        }
        //compare = (v1 - v2) == 0 ? 0 : (v1 - v2) > 0 ? 1 : -1;
        return this.sortRule == -1 ? -(compare) : compare;
    },
    jsSort: function (dt) {
        var _this = this;
        dt.sort(function (x, y) {
            return _this.compareFunction(x, y);
        });
    },
    getSortType: function (target) {
        var dic = this.sortTypeDic;
        var txt = (target.textContent || target.innerText);
        var argTxt = target.getAttribute("data-arg");
        if (!argTxt) argTxt = "";
        txt += argTxt;
        if (!dic[txt]) return "";
        var sortType = dic[txt][1];
        return sortType;
    },

    _onSortting: function (sortType) {//处理事件触发的逻辑
        if (sortType == "") return false;
        this.sortingEvent(this, sortType);
    },

    //[event]:
    sortingEvent: function (sender, sortType) {
        //排序事件
    },
    //[event]:
    sortcomplete: function (sender) {
        //异步事件排序完成触发
    }

};

(function () {
    /*
    视图的父类需要子类提供的属性:{
    SubClass.prototype.pageWrapper = ;
    SubClass.prototype.pageSize = ;
    SubClass.prototype.hsTemplate = ;
    SubClass.prototype.indexTemplate = ;
    }*/
    var _this,
        hashhandles = {},
		tuiguang,
		hkhqtip,
		bankuan;

    function PageView(update) {
        __init__.call(this, update);
        _this.presenter = new Presenter(_this);

    }

    PageView.prototype.init = function (quoteDs, upateArgs, sortDataDic) {
        var template = this.template;
        this.template.render.context = this.template;
        this.template.sortDataDic = sortDataDic;
        this.list = new ListView(this.template.render);
        this.list.dataService = quoteDs;
        FixedTableHeader.clear();
        this.template.sortcomplete = function () {
            FixedTableHeader.init(template);
        };

        _this.list.onLoadCompleted = function () {
            FixedTableHeader.init(template);
        };
        this.list.onInitCompleted = function () {
            _this.pageWrapper.setPageCount(this.pageCount);
            _this.pageWrapper.CreatePageNav(1);
            //表头固定
            FixedTableHeader.init(template);
        };

        if (upateArgs) {
            this.setAutoUpdate(upateArgs);
        }
        this.list.init();
        viewstate["parameters"] = quoteDs.parameters;
    };

    function __init__(update) {
        if (_this) {
            $("listview").onclick = null;
            if ($("change")) {
                $("change").onchange = null;
            }
            _this.dispose();
        }
        _this = this;
        _this.update = update;
        _this.pageWrapper.pageChange = function (n) {
            _this.presenter.update(n);
        };
    }

    PageView.prototype.bind = function (ds, callback) {
        this.list.dataService = ds;
        this.list.load(callback);
    };

    PageView.pushhash = function (hash, func) {
        if (hashhandles[hash] === undefined) {
            hashhandles[hash] = { key: hash, funcList: [] };
        }
        hashhandles[hash].funcList.push(func);
    };

    PageView.bindhash = function (hash, func) {

        if (hash instanceof Array) {
            for (var i = 0, n = hash.length; i < n; i++) {
                this.pushhash(hash[i], func);
            }
        } else {
            this.pushhash(hash, func);
        }
    };

    PageView.onhash = function (hash, id, subid) {
        var handle = hashhandles[hash + "_" + id + "_" + subid] ||
            hashhandles[hash + "_" + id] ||
            hashhandles["_" + id + "_" + subid] ||
            hashhandles["_" + id];
        var args = [];
        var isrun = true;
        if (handle === undefined) {
        } else {
            if (handle.key != "mk0141_1" && handle.key != "mk0142_1" && handle.key != "mk0144_1" && handle.key != "mk0144_12" && handle.key != "50_1" && handle.key != "28HSCI_1" && handle.key != "28HSCCI_1" && handle.key != "28HSCIINDEX_1" && handle.key != "28HSCEI_1" && handle.key != "28HSCEIINDEX_1" && handle.key != "28GEM_1" && handle.key != "52_1") {
            } else {
                isrun = false;
            }
        }
        if (isrun) {
            clearInterval(hkhqtip);
            if (handle === undefined) {
                //console.log("[clearInterval]"+hkhqtip);
            } else {
                //console.log(handle.key+"[clearInterval]"+hkhqtip);
            }
            //$("bgutip").innerHTML="";
        }
        if (handle === undefined) {
            return;
        }
        args = [hash, id, subid, handle.key];
        for (var i = 0, n = handle.funcList.length; i < n; i++) {
            handle.funcList[i].apply(null, args);

        }
    };

    //新股列表
    PageView.bindhash("285001_0", function (hash) {
        viewstate["sortType"] = "L";
        viewstate["sortRule"] = "-1";
    });

    //板块类表hash
    PageView.bindhash(["_0_2", "_12_2", "_12_3"], function (hash, id, subid, key) {
        $("bklistheader").innerHTML = '<div class="mod-item"><div class="item-header"><h4 id="bkhqtitle">行情</h4></div><div class="item-content"><img  id="bkhqimg" width="240" height="135"  data-src="http://pifm3.eastmoney.com/EM_Finance2014PictureInterface/Index.aspx?id=BK0{$id}1&imageType=rs&token=44c9d251add88e27b65ed86506f6e5da"></div></div><div class="mod-item"><div class="item-header"><h4 id="zjlxtitle">资金流向</h4></div><div class="item-content"><a target="_blank"><img id="zjlximg" width="240" height="135" data-src="http://hq2qt.eastmoney.com/EM_New_CapitalPictureProducter/Picture/{$id}rs.png" /></a></div></div><div class="mod-item lzbk"><div class="item-header"><h4 id="zjlxphtitle">资金流向排行</h4></div><div id="bkggph" class="mod-datas"><table class="data-table"><tr><th>排序</th><th>名称</th><th>相关资讯</th><th>净流入(万)</th></tr><tr><td>-</td><td>-</td><td><a target="_blank">股吧</a> <a target="_blank">资金流</a> <a  target="_blank">研报</a></td><td><span class="numeric red">-</span></td></tr></table></div></div><div class="space-5"></div>';
        bankuan.setimg();
        bankuan.paihang(hash + key);
    });

    //成分股
    PageView.bindhash(["_0_6"], function (hash, id, subid, key) {

        var url = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=" + hash + "&sty=FCIF&st=c&sr=-1&p=1&ps=50&cb=&js=var cgfdata=(x)&token=7bc05d0d4c3c22ef9fca8c2a912d779c";

        JsLoader.load(url, "utf-8", function() {
            var dt = cgfdata;
            var dr = dt.split(",");
            var code = dr[1];
            var name = dr[2];
            var close = dr[3];
            var open = dr[4];
            var totalCount = dr[5];
            var totalAmount = dr[6];
            //[涨|平|跌|停牌] 296|128|717|91
            var zdp = dr[11].toString().split("|");
            var raise = zdp[0];
            var reduce = zdp[2];
            var exact = zdp[3];

            var day3Raise = dr[12];
            var day5Raise = dr[13];
            var day6Raise = dr[14];
            var day10Raise = dr[15];

            var html = '<div class="mod-item"><div class="item-header"><h4 id="bkhqtitle">' + name + '分时行情</h4></div><div class="item-content">' +
                '<a  href="http://quote.eastmoney.com/zs' + code + '.html" target="_blank"><img  id="bkhqimg" width="260" height="135"  ' +
                'src="http://pifm3.eastmoney.com/EM_Finance2014PictureInterface/Index.aspx?id=' + hash + '&imageType=rs&token=7bc05d0d4c3c22ef9fca8c2a912d779c"></a>' +
                '</div></div><div class="mod-item"><div class="item-header"><h4 id="zjlxtitle">' + name + '日K行情</h4></div>' +
                '<div class="item-content"><a  href="http://quote.eastmoney.com/zs' + code + '.html" target="_blank"><img id="zjlximg" width="240" height="135" src="http://pifm3.eastmoney.com/EM_Finance2014PictureInterface/Index.aspx?id=' + hash + '&imageType=ks&token=7bc05d0d4c3c22ef9fca8c2a912d779c" /></a></div></div><div class="mod-item lzbk"><div class="item-header"><h4 id="zjlxphtitle">' + name + '数字行情</h4></div>';

            html += '<div id="bkggph" class="mod-datas">';

            html += '<table class="digitalQuote"><tr>';
            html += '<td  width="22%" class="bold">行情数据</td>';
            html += '<td  width="38%">最新：<span>' + close + '</span><br/>开盘：<span class="open">' + open + '</span></td>';
            html += '<td  width="38%">总量：<span class="totalCount">' + totalCount + '</span><br/>总额：<span class="totalAmount">' + totalAmount + '</span></td></tr>';
            html += '<tr><td class="bold">涨跌家数</td><td><span id="sortRaise" class="red">上涨：<span class="raise">' + raise + '</span></span><br/>' +
                '<span class="green"  id="sortReduce">下跌：<span class="reduce">' + reduce + '</span></span></td><td><span style="color:black;">持平：<span class="exact">' + exact + '</span></span></td></tr>';

            html += '<tr><td class="bold">阶段涨幅</td><td><span style="padding-left:5px; font-weight:200;">5日：</span>';

            if (day3Raise.indexOf("-") < 0) {

                html += '<span class="3dayRaise red">';
            } else {
                html += '<span class="3dayRaise green">';
            }
            html += day3Raise + '%</span><br/>20日：';

            if (day5Raise.indexOf("-") < 0) {

                html += '<span class="5dayRaise red">';
            } else {
                html += '<span class="5dayRaise green">';
            }

            html += day5Raise + '%</span></td>';
            html += '<td>60日：';
            if (day6Raise.indexOf("-") < 0) {

                html += '<span class="6dayRaise red">';
            } else {
                html += '<span class="6dayRaise green">';
            }

            html += day6Raise + '%</span><br/>今年：';
            if (day10Raise.indexOf("-") < 0) {

                html += '<span class="10dayRaise red">';
            } else {
                html += '<span class="10dayRaise green">';
            }

            html += day10Raise + '%</span></td></tr></table>';

            $("bklistheader").innerHTML = html;

            //设置面包屑
            $('brendnav').innerHTML += '&gt; <a href="#10_0_0_u?sortType=C&amp;sortRule=-1" target="_blank">沪深股市</a> &gt; ' +
                '<a href="index.html#zyzs_0_1" target="_blank">沪深指数</a> &gt; ' + name + '成分股</div>';

            var menu = new TreeMenu("#treemenu");

            var item = new TreeItem("0", "#35", "", null, "1");
 
            menu.init(item);

            document.getElementById("sortRaise").onclick = function () {
                var tab = document.getElementById("fixed");
                var tr = tab.getElementsByTagName("tr")[0];
                //涨跌幅
                var td = tr.getElementsByTagName("th")[6];
                if (td.getElementsByTagName("b")[0].className != "icon-change-up") {
                    td.click();
                }
            };


            document.getElementById("sortReduce").onclick = function () {
                var tab = document.getElementById("fixed");
                var tr = tab.getElementsByTagName("tr")[0];
                //涨跌幅
                var td = tr.getElementsByTagName("th")[6];
                if (td.getElementsByTagName("b")[0].className == "icon-change-up") {
                    td.click();
                }
            };

        });

    });

    //hash_id_subid; hash 数据ID，id树形菜单大项ID, subid 树形菜单子项ID
    PageView.bindhash(["21_0", "11_0", "_0_4"], function (hash, id, subid, key) {
        var market = "沪市",
            unit = "美元",
            url = "http://hq2gjqh.eastmoney.com/EM_Futures2010NumericApplication/Index.aspx?Type=z&jsname=forexdata&IDs=",
            forexCode = "uscny0";
            //text = $("bgutip").getAttribute("data-template") || $("bgutip").innerHTML;
        //$("bgutip").setAttribute("data-template", text);
        if (hash === "21" || hash === "absz") {
            market = "深市";
            unit = "港币";
            forexCode = "hkcny0";
        }

        url = url + forexCode;
        //text = text.replace("{$market}", market).
                    //replace(/\{\$unit\}/g, unit);
        JsLoader.load(url, "utf-8", function () {
            var dt = forexdata && forexdata.futures;
            var dr = dt[0].split(",");

            //$("bgutip").innerHTML = text.replace("{$rmb}", dr[5]);
            document.body.className = "module-" + key.replace(/_/g, "-").replace(/^-/, "");
        });
    });

    PageView.bindhash(["1,7,1_7"], function () {
        var sortType = Utility.getQueryString("sortType");
        var sortRule = Utility.getQueryString("sortRule");
        viewstate["sortType"] = sortType || "A";
        viewstate["sortRule"] = sortRule || "1";
    });

    //美股延迟公告
    if ($("usnews")) {
        $("usnews").style.display = "none";
    }

    PageView.bindhash(["_2"], function () {
        $("usnews").style.display = "block";
    });

    //三板默认排序为最新价
    PageView.bindhash(["_0_3"], function () {
        var sortType = Utility.getQueryString("sortType");
        viewstate["sortType"] = sortType || "B";
    });

    //比特币
    PageView.bindhash(["_10"], function () {
        var url = "http://hq2gjqh.eastmoney.com/EM_Futures2010NumericApplication/Index.aspx?Type=z&jsname=forexdata&IDs=uscny0";
        JsLoader.load(url, "utf-8", function () {
            var dt = forexdata && forexdata.futures;
            var dr = dt[0].split(",");
            //$("bgutip").innerHTML = "说明：￥代表人民币，﹩代表美元,1美元=<span class=\"red\">" + dr[5] + "</span>人民币。<a href=\"http://quote.eastmoney.com/center/list.html#forex_6\" target=\"_blank\">每日更多汇率变动>></a>";
            document.body.className = "module-10-0";
        });
    });

    //港股
    PageView.bindhash(["50_1", "28HSCI_1", "28HSCCI_1", "28HSCIINDEX_1", "28HSCEI_1", "28HSCEIINDEX_1", "28GEM_1", "52_1"], function () {
        var url = "http://183.136.160.59/EM_Quote2010NumericApplication/index.aspx?type=s&sortType=D&sortRule=-1&pageSize=1&page=1&jsName=hktime&style=50";
        var uphktime = function () {
            JsLoader.load(url, "utf-8", function () {
                var dt = hktime && hktime.rank;
                var dr = dt[0].split(",");
                for (var i = 0; i < dt.length; i++) {
                    var _dr = dt[i].split(",");
                    if (_dr[28] > dr[28]) {
                        dr = _dr;
                    }
                }
                //$("bgutip").innerHTML = "行情时间：" + dr[28] + "  (据港交所要求，全部港股的列表行情必须延时15分钟，点击个股可查看港股实时行情。)";
                document.body.className = "module-1-0";
            });
        };
        clearInterval(hkhqtip);
        uphktime();
        hkhqtip = setInterval(uphktime, 10000);
        //console.log("[bindhashA]"+hkhqtip);
    });
    //港股(港股通)
    PageView.bindhash(["mk0141_1", "mk0142_1", "mk0144_1", "mk0144_12", "mk0146_12"], function () {
        var sortType = Utility.getQueryString("sortType");
        viewstate["sortType"] = sortType || "C";
        var url = "http://183.136.160.59/EM_Quote2010NumericApplication/index.aspx?type=s&sortType=C&sortRule=-1&pageSize=10&page=1&jsName=hktime&style=50";
        var uphktime = function () {
            JsLoader.load(url, "utf-8", function () {
                var dt = hktime && hktime.rank;
                var dr = dt[0].split(",");
                for (var i = 0; i < dt.length; i++) {
                    var _dr = dt[i].split(",");
                    if (_dr[28] > dr[28]) {
                        dr = _dr;
                    }
                }
                //$("bgutip").innerHTML = "行情时间：" + dr[28] + "  (据港交所要求，全部港股的列表行情必须延时15分钟，点击个股可查看港股实时行情。)";
                document.body.className = "module-1-0";
            });
        };
        clearInterval(hkhqtip);
        uphktime();
        hkhqtip = setInterval(uphktime, 10000);
        //console.log("[bindhashB]"+hkhqtip);
    });
    //股指期货
    PageView.bindhash(["12.1.1_5_3", "12_5_3", "12.1_5_3", "12.2_5_3"], function () {
        var _str_ = '<div class="mod-item"><div class="item-header"><h4><a href="http://quote.eastmoney.com/zs000300.html" target="_blank">沪深300指数</a></h4></div><div class="item-content"><a href="http://quote.eastmoney.com/zs000300.html" target="_blank"><img src="http://hqgbpic.eastmoney.com/EM_Quote2010PictureProducter/Index.aspx?ImageType=RT&ID=0003001" alt="沪深300指数"></a><div class="buttons"><a href="http://quote.eastmoney.com/zs000300.html" target="_blank" class="btn-bigimg"></a>&nbsp; <a href="http://guba.eastmoney.com/topic,szzs.html" target="_blank" class="btn-gubar"></a></div></div></div>';
        _str_ += '<div class="mod-item"><div class="item-header"><h4><a href="http://quote.eastmoney.com/zs000016.html" target="_blank">上证50指数</a></h4></div><div class="item-content"><a href="http://quote.eastmoney.com/zs000016.html" target="_blank"><img src="http://hqgbpic.eastmoney.com/EM_Quote2010PictureProducter/Index.aspx?ImageType=RT&ID=0000161" alt="上证50指数"></a><div class="buttons"><a href="http://quote.eastmoney.com/zs000016.html" target="_blank" class="btn-bigimg"></a>&nbsp; <a href="http://guba.eastmoney.com/topic,szzs.html" target="_blank" class="btn-gubar"></a></div></div></div>';
        _str_ += '<div class="mod-item"><div class="item-header"><h4><a href="http://quote.eastmoney.com/zs399905.html" target="_blank">中证500指数</a></h4></div><div class="item-content"><a href="http://quote.eastmoney.com/zs399905.html" target="_blank"><img src="http://hqgbpic.eastmoney.com/EM_Quote2010PictureProducter/Index.aspx?ImageType=RT&ID=3999052" alt="中证500指数"></a><div class="buttons"><a href="http://quote.eastmoney.com/zs399905.html" target="_blank" class="btn-bigimg"></a>&nbsp; <a href="http://guba.eastmoney.com/topic,szzs.html" target="_blank" class="btn-gubar"></a></div></div></div>';
        $("bklistheader").innerHTML = _str_ + '<div class="space-5"></div>';
    });
    PageView.bindhash(["13_5_3", "14_5_3"], function () {
        $("bklistheader").style.display = "none";
    });

    //DOM加载完成时事件处理函数，在适当的位置调用
    PageView.onDomReady = function () {

        var src = {
            piclist: baseSrc + "/piclist.js",
            gridlist: baseSrc + "/gridlist.js"
        };

        //加载面包屑导航
        var locationNav = {
            load: function (hash) {
                if (!hash) return;
                setBrendNav(document.getElementById("brendnav"), hash, function (quotepath) {
                    tuiguang.hyzq(quotepath[quotepath.length - 1]);
                });
            }
        };

        //处理板块列表头部
        bankuan = {// 

            test: function (style) {
                return /^28001|28002|28003|28013/.test(style);
            },

            interval: 60 * 1000,

            setimg: function () {
                if (!bankuan.test(viewstate["style"])) return;
                var zjlimg = $("zjlximg"),
                    zjldataSrc = zjlimg && zjlimg.getAttribute("data-src"),
                    bkhqimg = $("bkhqimg"),
                    bkhqdataSrc = bkhqimg && bkhqimg.getAttribute("data-src"),
                    id = viewstate["style"].substring(5),
                    images = [];

                if (!!zjldataSrc) {
                    zjlimg.src = zjldataSrc.replace("{$id}", id);
                    zjlimg.parentNode.href = "http://data.eastmoney.com/bkzj/" + id + ".html";
                    updateImage(zjlimg);
                    images.push(zjlimg);
                }

                if (!!bkhqdataSrc) {
                    bkhqimg.src = bkhqdataSrc.replace("{$id}", id);
                    updateImage(bkhqimg);
                    images.push(bkhqimg);
                }

                clearInterval(bankuan.imgtimer);
                bankuan.imgtimer = setInterval(function () {
                    if (quote.HSOpening) {
                        for (var i = 0; i < images.length; i++) {
                            updateImage(images[i]);
                        }
                    }
                }, bankuan.interval);

            },

            setTitle: function (title) {
                if (!bankuan.test(viewstate["style"])) return;

                var zjlxtitle = $("zjlxtitle"),
                    bkhqtitle = $("bkhqtitle"),
                    zjlxphtitle = $("zjlxphtitle"),
                    id = viewstate["style"].substring(5),
                    type = viewstate["style"].substr(0, 5);

                if (type === "28002") {

                    title = title + "行业";
                    title = title.replace("行业行业", "行业");

                } else if (type === "28001") {//地域

                    title = title + "板块";
                    title = title.replace("板块板块", "板块");
                } else if (type === "28003" || type === "28013") {
                    title = title + "概念";
                    title = title.replace("概念概念", "概念");
                }
                bkhqtitle.innerHTML = title + "行情";
                if (bankuan.nodata) {
                    zjlxtitle.innerHTML = title + "资金流向";
                    zjlxphtitle.innerHTML = title + "个股资金流向排行";
                } else {
                    zjlxtitle.innerHTML = "<a href=\"http://data.eastmoney.com/bkzj/" + id + ".html\" target=\"_blank\">" + title + "资金流向</a>";
                    zjlxphtitle.innerHTML = "<a href=\"http://data.eastmoney.com/bkzj/" + id + ".html\" target=\"_blank\">" + title + "个股资金流向排行</a>";
                }


            },

            paihang: function (titlearg) {

                if (!bankuan.test(viewstate["style"])) return;
                bankuan.id = viewstate["style"].substring(5);
                //var url = "http://hq2data.eastmoney.com/bk/data/zjl/" + bankuan.id + ".js";
                var url = "http://nufm.dfcfw.com/EM_Finance2014NumericApplication/JS.aspx?type=CT&cmd=C.BK0" + bankuan.id + "1&sty=DCFFPBFMS&st=(BalFlowMain)&sr=-1&p=1&ps=5&cb=&js=var%20dt=[(x)]&token=44c9d251add88e27b65ed86506f6e5da";

                function load() {

                    JsLoader.load(url + "&v=" + Math.random(), "utf-8", function () {
                        var header = '<table class="data-table" width="100%" >' +
                            '<tr>' +
                              '<th>排序</th>' +
                              '<th>名称</th>' +
                              '<th>相关资讯</th>' +
                              '<th>净流入</th>' +
                            '</tr>';

                        var row = '<tr>' +
                          '<td>{$num}</td>' +
                          '<td> <a href="http://quote.eastmoney.com/{$data[1]}.html" target="_blank">{$data[2]}</a> </td>' +
                          '<td><a href="http://guba.eastmoney.com/topic,{$data[1]}.html" target="_blank">股吧</a> ' +
                               '<a href="http://data.eastmoney.com/zjlx/{$data[1]}.html" target="_blank">资金流</a> ' +
                               '<a href="http://data.eastmoney.com/report/{$data[1]}.html" target="_blank">研报</a></td>' +
                          '<td><span class="numeric {$color}">{$data[3]}</span></td>' +
                        '</tr>';
                        var footer = '</table>';
                        var tpl = new JSTemplate(header, row, footer);
                        var dataRow = [];
                        if (dt === undefined) return;
                        for (var i = 0, n = dt.length; i < n; i++) {
                            dataRow = String(dt[i]).split(",");
                            tpl.set("data", dataRow);
                            tpl.set("color", Quote.Tool.className(dataRow[3]));
                            tpl.set("num", i + 1);
                            tpl.parse();
                        }
                        if (dt.length > 0) {
                            bankuan.nodata = false;
                            $("bkggph").innerHTML = tpl.toHTML();
                        } else {
                            bankuan.nodata = true;
                            $("bkggph").innerHTML = header + '<tr><td colspan="4" style="vertical-align: middle; height:133px;">暂无数据</td></tr>' + footer;
                        }

                        //设置标题
                        setBrendNav(document.createElement("div"), titlearg, function (quotepath) {
                            bankuan.setTitle(quotepath[quotepath.length - 1]);
                        });

                    });
                } //end load();                
                clearInterval(bankuan.datatimer);
                bankuan.datatimer = setInterval(function () {
                    if (quote.HSOpening) {
                        load();
                    }
                }, bankuan.interval);
                load();
            }
        };

        //推广条
        tuiguang = {

            element: $("tui"),

            init: function (v) {
                var content = window["tgdata"] && (tgdata[v["style"]] ||
										  tgdata[v["style"] + "_" + v["tree-extend-position"]] ||
										  tgdata["_" + v["tree-extend-position"] + "_" + v["tree-sub-position"]]);
                var i = 0;

                if (!this.element) return;
                if (content instanceof Array) {
                    i = v["style"].substring(4, 5);
                    content = content[i - 1] || "";


                }

                if (content) {
                    this.element.style.display = "block";
                    this.element.innerHTML = '<span class="btn-hot"></span>' + content + '<div class="space-5"></div>';
                } else {
                    this.element.style.display = "none";
                }

                //this.element.innerHTML = (content) ? '<span class="btn-hot"></span>' + content + '<div class="space-5"></div>' : '';

            },

            //行业专区
            hyzq: function (title) {
                var elem = document.getElementById("hyzq");
                var id = viewstate["style"].substring(5);
                if (!elem) return;
                elem.innerHTML = '<a href ="http://stock.eastmoney.com/hangye/hy' + id + '.html" target="_blank">' + title + '专区</a>';
            }
        };

        var View = {

            init: function (url) {
                var hash = getHash(url);
                var config = new ConfigArgs();
                var hashArgs = hash.split("_");
                var sortType = Utility.getQueryString("sortType");
                var sortRule = Utility.getQueryString("sortRule");
                var mode = Utility.getQueryString("mode", "grid");
                viewstate["style"] = config.style || hashArgs[0] || "10";
                viewstate["tree-extend-position"] = hashArgs[1] || "0";
                viewstate["tree-sub-position"] = hashArgs[2] || "0";
                viewstate["sortType"] = config.sortType || sortType || "C";
                viewstate["sortRule"] = config.sortRule || sortRule || "-1";
                var className = "module-" + viewstate["tree-extend-position"];
                if (viewstate["tree-sub-position"] == 3 || viewstate["tree-sub-position"] == 2 || viewstate["tree-sub-position"] == 6) {
                    className += "-" + viewstate["tree-sub-position"];
                }
                PageView.onhash(viewstate["style"], viewstate["tree-extend-position"], viewstate["tree-sub-position"]);
                tuiguang.init(viewstate);
                locationNav.load(hash);
                setChannelLinks();
                document.body.className = className;
                //成分股隐藏select
                if (hash == "35_0_1") {
                    document.body.className = "module-1";
                }
                this.createUI(mode);
            },

            createUI: function (mode) {

                var pageView;

                $("listview").removeAttribute("class");
                $("listview").innerHTML = "<div class=\"loading\">正在加载...</div>";
                if ($("pagenav") != null) $("pagenav").innerHTML = "";

                if (mode == "pic") {
                    document.body.id = "picview";
                    $("listview").className = "picview";
                    JsLoader.load(src.piclist, "gb2312", function () {
                        pageView = new PicPageView();
                    });
                }
                else {
                    document.body.id = "gridview";
                    $("listview").className = "gridview";
                    JsLoader.load(src.gridlist, "gb2312", function () {
                        pageView = new GridPageView(true);
                    });
                }


            }

        };

        function isExternal(href) {
            var self = location.pathname;
            self = self.split("/");
            self = (self[self.length - 1] || "").split("#")[0] || "";
            href = href.split("/");
            href = (href[href.length - 1] || "").split("#")[0] || "";

            return href !== self;

        }

        function update() {
            var target = DomEvent.getEventTarget();
            if (target.className === "text") {
                target = target.parentNode;
            }

            if (target.href && target.href !== location.href && !isExternal(target.href)) {
                location.href = target.href;
                menu.setCurrent(target.href);
                View.init(target.href);
            }
        }

        var locationElem = document.getElementById("brendnav");
        if(typeof(treeMenu)!="undefined") DomEvent.addEvent(treeMenu, "click", update);
        DomEvent.addEvent(locationElem, "click", update);
        DomEvent.addEvent(locationElem, "click", function (e) {
            var target = DomEvent.getEventTarget();
            if (target.tagName.toUpperCase() == "A") {
                tree.setCurrent(target.href);
            }
        });
        //绑定视图模式切换事件
        DomEvent.addEvent(document.body, "click", function () {
            // document.body.onclick = function() {
            var sender = DomEvent.getEventTarget();
            if (sender.id == "v1" || sender.id == "v2") {
                View.init();
            }
            // };
        });

        //排序提示消息事件
        var closetip = document.getElementById("closetip");
        if (closetip) {
            closetip.onclick = function () {
                this.parentNode.style.display = "none";
            };
        }

        //过2秒自动隐藏排序标签
        var $sortTip = $("sorttip");
        setTimeout(function () {
            if ($sortTip && $sortTip.nodeType === 1) {
                $sortTip.style.display = "none";
            }
        }, 2000);

        View.init();

    };
    window.PageView = PageView;
})();

PageView.onDomReady();